# 非機能要件書: 3世代つながる認知症予防アプリ「脳活ファミリー」

> **ドキュメントバージョン**: 1.0.0
> **作成日**: 2026-02-15
> **Phase**: 1 - 要件定義
> **ステータス**: Draft
> **関連文書**: [機能要件書](./requirements.md)

---

## 目次

1. [NFR-001: パフォーマンス](#nfr-001-パフォーマンス)
2. [NFR-002: セキュリティ](#nfr-002-セキュリティ)
3. [NFR-003: アクセシビリティ](#nfr-003-アクセシビリティ)
4. [NFR-004: 可用性・信頼性](#nfr-004-可用性信頼性)
5. [NFR-005: スケーラビリティ](#nfr-005-スケーラビリティ)
6. [NFR-006: ユーザビリティ](#nfr-006-ユーザビリティ)
7. [NFR-007: 互換性](#nfr-007-互換性)
8. [NFR-008: 国際化](#nfr-008-国際化)
9. [NFR-009: テスト戦略](#nfr-009-テスト戦略)
10. [NFR-010: 運用・監視](#nfr-010-運用監視)

---

## NFR-001: パフォーマンス

### NFR-001-01: Core Web Vitals

| 指標 | 目標値 | 測定ツール | 備考 |
|------|--------|-----------|------|
| FCP (First Contentful Paint) | < 1.8s | Lighthouse / PageSpeed Insights | モバイル3G環境でも達成 |
| LCP (Largest Contentful Paint) | < 2.5s | Lighthouse / PageSpeed Insights | ヒーロー画像・キャラクター読み込み含む |
| CLS (Cumulative Layout Shift) | < 0.1 | Lighthouse / PageSpeed Insights | フォント読み込みによるレイアウトシフト防止 |
| INP (Interaction to Next Paint) | < 200ms | Lighthouse / PageSpeed Insights | タップ・スワイプ操作のフィードバック |
| TTFB (Time to First Byte) | < 800ms | Lighthouse / PageSpeed Insights | CDN活用による最適化 |

### NFR-001-02: Lighthouse スコア

| カテゴリ | 目標スコア | 最低許容値 |
|---------|-----------|-----------|
| Performance | 90+ | 85 |
| Accessibility | 100 | 95 |
| Best Practices | 100 | 95 |
| SEO | 100 | 95 |

**測定条件:**

- デバイス: モバイル（Moto G Power相当）
- ネットワーク: Slow 4G（RTT 150ms, スループット 1.6Mbps）
- 測定タイミング: 各デプロイ時 + 週次定期チェック

### NFR-001-03: API応答時間

| エンドポイントカテゴリ | p50 | p95 | p99 | 備考 |
|---------------------|-----|-----|-----|------|
| 認証系（ログイン/トークンリフレッシュ） | < 100ms | < 200ms | < 500ms | CC-Auth経由 |
| テスト問題取得 | < 50ms | < 100ms | < 200ms | キャッシュ活用 |
| スコア記録 | < 50ms | < 100ms | < 200ms | 非同期処理可 |
| ファミリーダッシュボード | < 100ms | < 200ms | < 500ms | 集約クエリ |
| ヘルスレポート生成 | < 500ms | < 1000ms | < 2000ms | PDF生成含む |
| メッセージ送信 | < 50ms | < 100ms | < 200ms | WebSocket/SSE |

### NFR-001-04: ユーザー体感パフォーマンス

| 操作 | 目標 | 根拠 |
|------|------|------|
| テスト開始までの操作数 | 3タップ以内（ホーム画面 → テスト選択 → 開始） | シニアの操作負荷軽減。Hick's Lawに基づく選択肢最小化 |
| 画面遷移時間 | < 1秒（シニアモード: < 800ms） | シニアの集中力持続。300ms以上の遅延は不安を誘発 |
| アニメーションフレームレート | 60fps | ジャンク発生時はアニメーション品質低下よりフレーム維持を優先 |
| テスト結果表示 | テスト完了後 < 500ms | 即時フィードバックによる達成感演出 |
| オフライン時テスト開始 | < 200ms | Service Workerキャッシュからの即時読み込み |
| キャラクターアニメーション | 60fps維持、GPU合成のみ | `transform`, `opacity` のみ使用。`will-change` は最小限 |

### NFR-001-05: バンドルサイズ

| 対象 | 目標 | 最大許容値 |
|------|------|-----------|
| 初期ロードJS | < 100KB (gzip) | 150KB |
| 初期ロードCSS | < 20KB (gzip) | 30KB |
| ページ遷移時の追加読み込み | < 50KB (gzip) | 80KB |
| キャラクターアセット（初回） | < 200KB | 300KB |
| テストゲームモジュール（各ゲーム） | < 80KB (gzip) | 120KB |

**最適化手法:**

- Next.js App Routerによるコード分割・ストリーミングSSR
- 画像: WebP/AVIF形式、`next/image` によるレスポンシブ最適化
- フォント: `next/font` によるサブセット化・プリロード
- Tailwind CSS v4: PurgeCSS内蔵による未使用スタイル除去
- motion/react: Tree-shakingによる使用アニメーションのみバンドル
- Service Workerによるプリキャッシュ戦略

### NFR-001-06: メモリ使用量

| 対象 | 目標 | 備考 |
|------|------|------|
| ヒープメモリ | < 50MB | テストゲームプレイ中 |
| DOM ノード数 | < 1500 | 画面あたり |
| IndexedDB | < 100MB / ユーザー | オフラインデータ + スコア履歴 |

---

## NFR-002: セキュリティ

### NFR-002-01: データ暗号化

| 対象 | 暗号化方式 | 鍵管理 |
|------|-----------|--------|
| ヘルスデータ（認知テストスコア） | AES-256-GCM | AWS KMS管理、年次ローテーション |
| 個人情報（氏名、生年月日、メール） | AES-256-GCM | AWS KMS管理、年次ローテーション |
| 通信経路 | TLS 1.3 | ACM証明書自動更新 |
| IndexedDB（オフラインデータ） | Web Crypto API (AES-GCM) | ユーザー固有鍵（認証トークンから派生） |
| バックアップデータ | AES-256-GCM | 専用バックアップ鍵、AWS KMS管理 |

### NFR-002-02: 認証・認可

| 項目 | 仕様 |
|------|------|
| 認証方式 | CC-Auth（AWS Cognito + JWT） |
| アクセストークン有効期限 | 1時間 |
| リフレッシュトークン有効期限 | 30日間（シニアモード: 90日間） |
| パスワードポリシー | 最低8文字、大文字小文字数字特殊文字各1つ以上 |
| ログイン試行制限 | 5回失敗で15分ロック |
| MFA | オプション（親世代に推奨、シニアモードではデフォルトOFF） |
| ソーシャルログイン | Google / Apple / LINE |
| 子供アカウント | COPPA準拠、保護者承認フロー必須 |

### NFR-002-03: 家族間の閲覧権限制御

| ロール | 権限 |
|--------|------|
| ファミリー管理者 | 全メンバーのスコア閲覧、メンバー招待/削除、ヘルスレポート出力、通知設定 |
| 親世代メンバー | シニア世代・子供世代のスコア閲覧、励ましメッセージ送信、自身のスコア管理 |
| シニア世代メンバー | 自身のスコア閲覧・テスト実施、家族からのメッセージ閲覧、共有設定の管理 |
| 子供世代メンバー | 自身のスコア閲覧・テスト実施、家族ランキング閲覧（年齢制限あり） |
| 招待済み医師 | 指定シニアメンバーのヘルスレポート閲覧（読み取り専用、期間限定） |

**閲覧制御の原則:**

- シニア世代は自身のデータ共有範囲を明示的に制御可能
- 子供世代のデータは保護者（親世代）のみ閲覧可能
- 医師へのレポート共有はシニア本人または管理者の明示的同意が必要
- 全データ共有にはオプトイン方式を採用（デフォルトは非共有）

### NFR-002-04: OWASP Top 10 対策

| リスク | 対策 |
|--------|------|
| A01: アクセス制御の不備 | ロールベースアクセス制御（RBAC）、API GatewayでのJWT検証、リソースレベルの所有者チェック |
| A02: 暗号化の失敗 | AES-256-GCM暗号化、TLS 1.3強制、安全な鍵管理（AWS KMS） |
| A03: インジェクション | パラメータ化クエリ、入力値バリデーション（Zod）、出力エスケープ（React自動エスケープ） |
| A04: 安全でない設計 | 脅威モデリング実施、設計レビュー、最小権限原則 |
| A05: セキュリティの設定ミス | セキュリティヘッダー設定（CSP, HSTS, X-Frame-Options）、デフォルト拒否ポリシー |
| A06: 脆弱なコンポーネント | 依存パッケージの週次自動監査（`npm audit`）、Dependabot有効化 |
| A07: 認証の失敗 | レート制限、アカウントロックアウト、セッション固定化対策 |
| A08: ソフトウェアとデータの整合性の不全 | CI/CDパイプラインの署名検証、SRI（Subresource Integrity） |
| A09: セキュリティログとモニタリングの不全 | CloudWatch Logs、不正アクセス検知アラート、監査ログ保持（1年間） |
| A10: サーバーサイドリクエストフォージェリ | URL検証、内部ネットワークへのアクセス制限、許可リスト方式 |

### NFR-002-05: 個人情報保護・法令遵守

| 項目 | 対応内容 |
|------|---------|
| 個人情報保護法（日本） | プライバシーポリシー公開、利用目的の明示、本人同意取得、開示請求対応（30日以内） |
| GDPR（EU一般データ保護規則） | データポータビリティ権（JSON/CSV形式）、消去権（「忘れられる権利」）、処理の法的根拠の記録 |
| COPPA（児童オンラインプライバシー保護法） | 13歳未満のアカウント作成時に保護者の検証可能な同意取得 |
| APPI（改正個人情報保護法） | 要配慮個人情報（ヘルスデータ）の取得同意、安全管理措置の実施 |

### NFR-002-06: データ保持期間ポリシー

| データ種別 | 保持期間 | 削除方法 |
|-----------|---------|---------|
| テストスコア履歴 | 5年間（アクティブユーザー）/ アカウント削除後30日 | 論理削除 → 30日後物理削除 |
| 個人情報 | アカウント有効期間中 / 削除申請後30日以内 | 即時論理削除 → 30日後物理削除 |
| ヘルスレポート | 生成後3年間 | 自動パージ |
| メッセージ履歴 | 2年間 | 自動アーカイブ → 削除 |
| 監査ログ | 1年間 | 自動パージ |
| バックアップデータ | 90日間 | 自動ローテーション |
| アカウント削除済みデータ | 30日間（復旧猶予期間） | 自動物理削除 |

### NFR-002-07: セキュリティヘッダー

```
Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-{random}'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.aidreams-factory.com wss://*.aidreams-factory.com;
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 0
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: camera=(), microphone=(self), geolocation=(), payment=()
```

---

## NFR-003: アクセシビリティ

### NFR-003-01: WCAG 2.1 準拠レベル

| レベル | 対応状況 | 備考 |
|--------|---------|------|
| Level A | 必須 | 全ガイドライン100%準拠 |
| Level AA | 必須 | 全ガイドライン100%準拠 |
| Level AAA | 部分対応 | シニアモード有効時にAAA準拠を目指す |

### NFR-003-02: コントラスト比

| モード | テキスト種別 | 最低コントラスト比 | 根拠 |
|--------|------------|-------------------|------|
| 通常モード | 本文テキスト | 4.5:1 | WCAG 2.1 AA（1.4.3） |
| 通常モード | 大きなテキスト（18px bold / 24px以上） | 3:1 | WCAG 2.1 AA（1.4.3） |
| 通常モード | UIコンポーネント・アイコン | 3:1 | WCAG 2.1 AA（1.4.11） |
| シニアモード | 本文テキスト | 7:1 | WCAG 2.1 AAA（1.4.6）準拠 |
| シニアモード | 大きなテキスト（24px bold / 30px以上） | 4.5:1 | WCAG 2.1 AAA（1.4.6）準拠 |
| シニアモード | UIコンポーネント・アイコン | 4.5:1 | 視認性向上 |

### NFR-003-03: タッチターゲットサイズ

| モード | 最小サイズ | 推奨サイズ | 間隔 | 根拠 |
|--------|-----------|-----------|------|------|
| 通常モード | 44px x 44px | 48px x 48px | 8px以上 | WCAG 2.5.8（Target Size Level AA） |
| シニアモード | 56px x 56px | 64px x 64px | 12px以上 | 運動機能低下への配慮、Fitts's Lawに基づく |
| 子供モード | 48px x 48px | 56px x 56px | 10px以上 | 子供の指サイズへの配慮 |

### NFR-003-04: 音声読み上げ・スクリーンリーダー対応

| 項目 | 仕様 |
|------|------|
| VoiceOver（iOS） | 全画面の操作フロー完全対応 |
| TalkBack（Android） | 全画面の操作フロー完全対応 |
| ARIA属性 | 全インタラクティブ要素に `aria-label` / `aria-describedby` 付与 |
| ランドマーク | `<header>`, `<nav>`, `<main>`, `<footer>` による構造化 |
| 見出し階層 | `h1` → `h2` → `h3` の論理的な階層維持 |
| フォーカス管理 | 画面遷移時のフォーカス移動、フォーカストラップ（モーダル） |
| ライブリージョン | スコア更新・タイマー表示は `aria-live="polite"` |
| テストゲーム | 全ゲームで音声フィードバック代替手段を提供 |

### NFR-003-05: 色覚多様性対応

| 対応項目 | 実装方法 |
|---------|---------|
| 情報伝達 | 色だけに依存しない（アイコン、テキストラベル、パターンを併用） |
| スコアインジケーター | 色 + 数値 + アイコン（上昇↑/下降↓/維持→）で表示 |
| グラフ | 色分け + パターン（点線、破線、太線）+ データラベル |
| テストゲーム | 色識別が必要なゲームでは形状・サイズの代替手段を提供 |
| カラーパレット | 赤-緑の同時使用を回避、色覚シミュレーションでの検証実施 |

### NFR-003-06: フォントサイズ・タイポグラフィ

| モード | テキスト種別 | 最小サイズ | 推奨サイズ | 行間 |
|--------|------------|-----------|-----------|------|
| 通常モード | 本文 | 16px (1rem) | 18px (1.125rem) | 1.6 |
| 通常モード | キャプション・補助テキスト | 14px (0.875rem) | 16px (1rem) | 1.5 |
| 通常モード | 見出し h1 | 28px (1.75rem) | 32px (2rem) | 1.3 |
| シニアモード | 本文 | 20px (1.25rem) | 22px (1.375rem) | 1.8 |
| シニアモード | キャプション・補助テキスト | 18px (1.125rem) | 20px (1.25rem) | 1.7 |
| シニアモード | 見出し h1 | 32px (2rem) | 36px (2.25rem) | 1.4 |

**タイポグラフィルール:**

- `text-balance` を見出しに使用（行末の体裁改善）
- `tabular-nums` を数値表示（スコア、タイマー）に使用
- システムフォントスタック優先（ウェブフォント読み込み遅延回避）
- ユーザーによるフォントサイズ変更（ブラウザ設定）を阻害しない（`rem` 単位使用）

### NFR-003-07: 動きの低減モード

| 項目 | 通常モード | 動き低減モード（`prefers-reduced-motion: reduce`） |
|------|-----------|------------------------------------------------|
| ページ遷移 | フェード + スライドアニメーション（200ms） | 即時切り替え（アニメーション無効） |
| キャラクターアニメーション | 全アニメーション再生 | 静止画のみ表示 |
| スコア表示 | カウントアップアニメーション | 即時数値表示 |
| ゲーム演出 | パーティクル・エフェクト表示 | エフェクト無効、結果テキストのみ |
| 通知 | スライドインアニメーション | 即時表示 |
| ローディング | スピナーアニメーション | 静的ローディングテキスト |

### NFR-003-08: キーボード操作

| 操作 | 対応 |
|------|------|
| Tab / Shift+Tab | 全インタラクティブ要素間の移動 |
| Enter / Space | ボタン・リンクのアクティベート |
| Escape | モーダル・ドロワーの閉じる |
| 矢印キー | テストゲーム内の選択肢移動、スライダー操作 |
| フォーカスリング | 全フォーカス可能要素に視覚的フォーカスインジケーター（3px, offset 2px） |

---

## NFR-004: 可用性・信頼性

### NFR-004-01: SLA（サービスレベル合意）

| 指標 | 目標 | 測定期間 | 計算除外 |
|------|------|---------|---------|
| 稼働率 | 99.9%（年間停止時間 < 8.76時間） | 月次 | 計画メンテナンス（月1回、深夜2:00-4:00 JST） |
| RTO（目標復旧時間） | < 1時間 | インシデント発生時 | - |
| RPO（目標復旧時点） | < 15分 | インシデント発生時 | - |

### NFR-004-02: オフラインファースト設計

| 機能 | オフライン対応 | 実装方法 |
|------|--------------|---------|
| 認知テスト実施 | 完全対応 | Service Worker + IndexedDB にテスト問題をプリキャッシュ |
| スコア記録 | 完全対応 | IndexedDB にローカル保存、オンライン復帰時に自動同期 |
| スコア履歴閲覧 | 部分対応 | 最新30日分をIndexedDBにキャッシュ |
| ファミリーダッシュボード | 部分対応 | 最終同期時のスナップショット表示（「最終更新: X分前」表示） |
| メッセージ送信 | 部分対応 | オフラインキュー → オンライン復帰時に送信 |
| ヘルスレポート生成 | 非対応 | サーバーサイド処理のためオンライン必須 |
| ユーザー登録・ログイン | 非対応 | 認証サーバーへの接続必須 |

**PWA要件:**

| 項目 | 仕様 |
|------|------|
| manifest.json | `display: "standalone"`, `theme_color`, `background_color` 設定 |
| Service Worker | Workbox ベース、キャッシュファースト + ネットワークフォールバック |
| インストールプロンプト | 3回目のアクセスで表示（シニアモード: 音声ガイド付き） |
| オフラインページ | カスタムオフラインページ（「次にインターネットにつながったとき、自動で同期します」） |
| バックグラウンド同期 | Background Sync APIによるオフラインキュー処理 |
| プッシュ通知 | Web Push API（テストリマインダー、家族からの励まし） |

### NFR-004-03: データ同期

| シナリオ | 同期方式 | コンフリクト解決 |
|---------|---------|----------------|
| オンライン復帰時 | 自動同期（Background Sync） | タイムスタンプベース（Last Write Wins） |
| 複数デバイス同時利用 | リアルタイム同期（WebSocket/SSE） | サーバーサイド最新値優先 |
| テストスコア記録 | 追記型（Append-only） | コンフリクト発生しない設計 |
| プロフィール更新 | 楽観的ロック（ETag） | ユーザーに差分確認を依頼 |

**同期状態UI:**

- オフライン時: 画面上部に「オフライン中」バナー（黄色、控えめ）
- 同期中: 「同期しています...」インジケーター（スピナー）
- 同期完了: 「同期完了」トースト通知（2秒後に自動消去）
- 同期エラー: 「同期に失敗しました。後で再試行します」（リトライボタン付き）

### NFR-004-04: バックアップ・リカバリ

| 対象 | バックアップ頻度 | 保持期間 | 方式 |
|------|----------------|---------|------|
| データベース（RDS） | 日次自動スナップショット + 継続的レプリケーション | 35日間 | AWS RDS自動バックアップ |
| ユーザーアップロードファイル（S3） | リアルタイムレプリケーション | 無期限（ライフサイクルポリシーで階層化） | S3 Cross-Region Replication |
| アプリケーション設定 | Git管理 + デプロイ時スナップショット | 無期限 | Git + AWS Systems Manager |

### NFR-004-05: 障害検知・自動復旧

| 障害種別 | 検知方法 | 自動復旧 |
|---------|---------|---------|
| アプリケーションクラッシュ | ECS タスクヘルスチェック失敗 | タスク自動再起動（最大3回） |
| メモリ逼迫 | CloudWatch メモリ使用率 > 80% | ECS オートスケーリング |
| CPU高負荷 | CloudWatch CPU使用率 > 70% | ECS オートスケーリング |
| DB接続エラー | ヘルスチェックエンドポイント失敗 | RDS Multi-AZ フェイルオーバー |
| 外部API障害 | タイムアウト・エラーレート監視 | サーキットブレーカーパターン |

---

## NFR-005: スケーラビリティ

### NFR-005-01: 同時接続ユーザー数

| フェーズ | 同時接続数 | DAU | 備考 |
|---------|-----------|-----|------|
| ローンチ初期（3ヶ月） | 500 | 2,000 | 単一AZ |
| 成長期（6ヶ月） | 2,000 | 10,000 | Multi-AZ |
| 安定期（1年） | 10,000 | 50,000 | オートスケーリング |
| 拡大期（2年） | 50,000 | 200,000 | Multi-Region検討 |

### NFR-005-02: オートスケーリング

| リソース | スケーリング条件 | 最小 | 最大 | クールダウン |
|---------|----------------|------|------|------------|
| ECS タスク | CPU > 70% or メモリ > 80% | 2 | 20 | 300秒 |
| RDS Read Replica | 読み取りクエリレイテンシ > 100ms | 0 | 3 | 600秒 |
| ElastiCache | メモリ使用率 > 75% | 1 | 5 | 300秒 |

### NFR-005-03: データ保持量

| データ種別 | 1ユーザーあたり | 保持期間 | 年間増加率 |
|-----------|---------------|---------|-----------|
| テストスコア履歴 | ~365レコード/年（1日1回） | 5年間（最大1,825レコード） | 線形 |
| テスト回答詳細 | ~365レコード/年（各5-10問） | 2年間 | 線形 |
| メッセージ履歴 | ~500メッセージ/年 | 2年間 | 線形 |
| ヘルスレポート | ~12レポート/年 | 3年間 | 線形 |
| プロフィール情報 | 1レコード | アカウント有効期間 | 固定 |
| アクティビティログ | ~1,000レコード/年 | 1年間 | 線形 |

**1ユーザーあたりの推定総データ量:** ~5MB/年、5年間で~25MB

### NFR-005-04: ファミリーグループ

| 項目 | 制限値 | 根拠 |
|------|--------|------|
| 1グループの最大メンバー数 | 20人 | 3世代 + 配偶者 + 兄弟姉妹を想定 |
| 1ユーザーの所属グループ数 | 3グループ | 両方の祖父母家族 + 自家族 |
| ファミリーダッシュボードのリアルタイム更新 | 20人同時表示 | WebSocket接続数の制限 |
| 招待リンク有効期限 | 7日間 | セキュリティ上の制限 |

---

## NFR-006: ユーザビリティ

### NFR-006-01: シニア向けUX原則

| 原則 | 実装指針 | 根拠 |
|------|---------|------|
| 認知負荷の最小化 | 1画面1アクション、選択肢は最大4つ、情報は段階的に開示 | Miller's Law（7±2の法則）のシニア適用 |
| 記憶負荷の排除 | 操作手順を画面上に常に表示、戻るボタンの明示 | シニアのワーキングメモリ負荷軽減 |
| エラー予防 | 危険な操作前に確認ダイアログ、Undo可能な設計 | Nielsen's Error Prevention |
| 一貫性の維持 | ナビゲーション位置固定、ボタンスタイル統一 | Jakob's Law |
| フィードバックの即時性 | 全操作に視覚 + 触覚（バイブレーション）フィードバック | 操作確認の安心感 |
| 漸進的な複雑性 | 初回は最小機能、使い慣れに応じて機能解放 | Progressive Disclosure |

### NFR-006-02: エラーメッセージ

**原則:** 技術用語を使わず、やさしい日本語で「何が起きたか」「どうすればよいか」を伝える

| エラー種別 | 技術的メッセージ | ユーザー向けメッセージ |
|-----------|----------------|---------------------|
| ネットワークエラー | `ERR_NETWORK` | 「インターネットにつながっていないようです。Wi-Fiがオンになっているか確認してください」 |
| 認証エラー | `401 Unauthorized` | 「ログインの有効期限が切れました。もう一度ログインしてください」 |
| サーバーエラー | `500 Internal Server Error` | 「ごめんなさい、一時的な問題が発生しています。少し時間をおいてから、もう一度お試しください」 |
| 入力エラー | `Validation Error` | 「（具体的な修正箇所を指し示して）ここを修正してください」 |
| ファイルサイズ超過 | `File too large` | 「写真が大きすぎます。別の写真を選んでください」 |
| オフライン時の非対応操作 | `Network Required` | 「この機能はインターネット接続が必要です。つながったら、もう一度お試しください」 |

**表示ルール:**

- トースト通知: 5秒間表示（シニアモード: 8秒間）、手動で閉じることも可能
- エラーアイコン: わかりやすいイラスト付き（キャラクターが困っている表情）
- 音声読み上げ: エラーメッセージは自動で `aria-live="assertive"` で通知

### NFR-006-03: 操作の取り消し・やり直し

| 操作 | 取り消し可能性 | 猶予期間 |
|------|-------------|---------|
| メッセージ送信 | 送信取り消し可能 | 5秒以内 |
| プロフィール変更 | 元に戻す機能あり | 変更後いつでも |
| ファミリーグループ退出 | 確認ダイアログ → 再参加可能 | 7日以内 |
| アカウント削除 | 確認ダイアログ → 復旧可能 | 30日以内 |
| テスト結果 | 取り消し不可（データ整合性のため） | - |
| データ共有設定変更 | 即時反映 + 元に戻す | いつでも |

### NFR-006-04: ヘルプ・チュートリアル

| 種別 | 内容 | 表示タイミング |
|------|------|--------------|
| 初回オンボーディング | アプリの目的、基本操作、初回テスト実施まで（5画面以内） | 初回起動時 |
| コンテキストヘルプ | 各画面の操作説明（吹き出しツールチップ） | ？アイコンタップ時 |
| ステップバイステップガイド | 新機能の操作手順（ハイライト付きウォークスルー） | 新機能初回アクセス時 |
| FAQ | よくある質問と回答 | 設定 → ヘルプ |
| 動画ヘルプ（シニア向け） | 操作方法の短い動画（30秒以内） | ヘルプセクション |
| ファミリーサポート | 家族メンバーへの操作サポート依頼機能 | 困ったときボタン |

### NFR-006-05: 初回体験（FTUE: First Time User Experience）

| ステップ | 目標時間 | 内容 |
|---------|---------|------|
| アプリ起動 → 登録完了 | < 2分 | ソーシャルログインを推奨（最小入力） |
| プロフィール設定 | < 1分 | 名前、世代選択、アバター選択のみ |
| 最初のテスト完了 | < 2分 | 簡単なチュートリアルテスト（3問） |
| **合計: 起動 → 初テスト完了** | **< 5分** | **5分以内に価値体験を完了** |

### NFR-006-06: 世代別UIモード

| モード | 対象世代 | 主な調整 |
|--------|---------|---------|
| シニアモード | 60歳以上 | フォント拡大、タッチターゲット拡大、コントラスト強化、アニメーション簡素化、音声ガイド |
| 標準モード | 30-60歳 | デフォルト設定 |
| キッズモード | 5-12歳 | 遊び心のあるUI、ふりがな表示、簡単な言葉遣い、保護者フィルター |
| ティーンモード | 13-30歳 | モダンUI、ゲーミフィケーション強化、SNS共有機能 |

**モード自動切り替え:** プロフィールの生年月日から自動判定。設定画面で手動変更可能。

---

## NFR-007: 互換性

### NFR-007-01: レスポンシブデザイン

**設計方針:** モバイルファースト

| ブレークポイント | 幅 | 対象デバイス | レイアウト |
|----------------|-----|------------|-----------|
| base (default) | 0px - 639px | スマートフォン（縦） | シングルカラム |
| sm | 640px - 767px | スマートフォン（横）/ 小型タブレット | シングルカラム（余白拡大） |
| md | 768px - 1023px | タブレット（縦） | 2カラム（ダッシュボード） |
| lg | 1024px - 1279px | タブレット（横）/ ノートPC | 2-3カラム |
| xl | 1280px - 1535px | デスクトップ | マルチカラム |
| 2xl | 1536px以上 | 大画面デスクトップ | マルチカラム + サイドパネル |

**実装ルール:**

- Tailwind CSS v4のブレークポイントユーティリティを使用
- `h-dvh`（dynamic viewport height）を使用してモバイルブラウザのアドレスバー問題に対応
- タッチデバイスとポインターデバイスで操作体験を最適化（`@media (hover: hover)`, `@media (pointer: fine)`）
- 横向き/縦向きの両方でレイアウトが崩れないことを保証

### NFR-007-02: 対応ブラウザ

| ブラウザ | サポートバージョン | 優先度 |
|---------|------------------|--------|
| Chrome（デスクトップ/Android） | 最新2バージョン | P0 |
| Safari（macOS/iOS） | 最新2バージョン | P0 |
| Firefox | 最新2バージョン | P1 |
| Edge | 最新2バージョン | P1 |
| Samsung Internet | 最新2バージョン | P2 |

**非対応ブラウザ:**

- Internet Explorer 全バージョン
- Opera Mini
- UC Browser

**非対応ブラウザ検出時:** 「このブラウザではご利用いただけません。Chrome、Safari、Firefoxの最新版をお使いください」メッセージを表示

### NFR-007-03: OS・デバイス対応

| OS | 最低バージョン | 備考 |
|-----|--------------|------|
| iOS | 16.0以上 | Safari WebKitエンジン制約考慮 |
| Android | 10.0以上 | WebView互換性テスト |
| macOS | 12.0 (Monterey)以上 | Safari + Chrome |
| Windows | 10以上 | Chrome + Edge + Firefox |

### NFR-007-04: PWA対応

| 項目 | 仕様 |
|------|------|
| ホーム画面追加 | iOS: Safari「共有→ホーム画面に追加」、Android: インストールプロンプト |
| アプリアイコン | 192x192, 512x512 (maskable + any) |
| スプラッシュスクリーン | テーマカラー背景 + アプリロゴ |
| オフラインページ | カスタムオフラインページ（キャラクター + メッセージ） |
| プッシュ通知 | Web Push API（テストリマインダー、家族メッセージ） |
| バックグラウンド同期 | Background Sync API（オフラインテスト結果のアップロード） |
| アプリ更新 | Service Worker更新検知 → ユーザーに更新通知 |

### NFR-007-05: 画面解像度・ピクセル密度

| 項目 | 対応 |
|------|------|
| 標準解像度 (1x) | 全アセット対応 |
| Retina/HiDPI (2x) | 全アセット対応 |
| Super Retina (3x) | アイコン・キャラクター画像対応 |
| 画像形式 | WebP（フォールバック: PNG）、AVIF（対応ブラウザ） |
| SVG | アイコン・イラスト（Lucide React） |

---

## NFR-008: 国際化

### NFR-008-01: 対応言語

| 言語 | ステータス | ローカルID | 備考 |
|------|-----------|-----------|------|
| 日本語 | デフォルト言語 | `ja` | 全機能完全対応 |
| 英語 | Phase 2対応 | `en` | 全機能完全対応 |
| 中国語（簡体字） | 将来対応 | `zh-CN` | 拡張可能な設計 |
| 韓国語 | 将来対応 | `ko` | 拡張可能な設計 |

### NFR-008-02: 国際化設計原則

| 項目 | 仕様 |
|------|------|
| 翻訳キー管理 | `next-intl` または同等ライブラリによるキーベース翻訳 |
| テキスト表示 | ハードコードテキスト禁止、全て翻訳キー経由 |
| 日付フォーマット | `Intl.DateTimeFormat` によるロケール自動判定 |
| 数値フォーマット | `Intl.NumberFormat` によるロケール自動判定（スコア表示など） |
| 通貨表示 | 将来の課金機能に備え、`Intl.NumberFormat` で通貨表示対応 |
| 文字方向 | LTR（左から右）をデフォルト、RTL対応は将来検討 |
| テキスト拡張 | 翻訳後のテキスト長が1.5倍になっても表示が崩れない設計 |
| 画像内テキスト | 画像にテキストを焼き込まない、オーバーレイで表示 |

### NFR-008-03: 地域対応

| 項目 | 日本（デフォルト） | 他地域対応時 |
|------|------------------|------------|
| タイムゾーン | JST (Asia/Tokyo) | ユーザーのローカルタイムゾーン自動検出 |
| 日付形式 | YYYY年MM月DD日 | ロケール依存 |
| テスト問題 | 日本語圏の文化に適したコンテンツ | 地域の文化・言語に適応 |
| 法的文書 | 日本法準拠 | 各地域の法規制に準拠 |

---

## NFR-009: テスト戦略

### NFR-009-01: テスト種別と目標

| テスト種別 | ツール | カバレッジ目標 | 実行タイミング |
|-----------|--------|-------------|--------------|
| ユニットテスト | Vitest | 80%以上（ステートメントカバレッジ） | 全コミット時（pre-commitフック） |
| コンポーネントテスト | Vitest + Testing Library | 主要コンポーネント100% | PR作成時 |
| 結合テスト | Vitest | 主要API連携フロー100% | PR作成時 |
| E2Eテスト | Playwright | 主要ユーザーフロー100% | デプロイ前 |
| アクセシビリティテスト | axe-core + Playwright | 全ページ100% | PR作成時 + デプロイ前 |
| パフォーマンステスト | Lighthouse CI | 全ページ基準値クリア | デプロイ前 |
| ビジュアルリグレッションテスト | Playwright screenshot comparison | 主要画面100% | PR作成時 |
| セキュリティテスト | OWASP ZAP / npm audit | 全エンドポイント | 週次 + リリース前 |

### NFR-009-02: テスト対象フロー（E2E）

| フロー | 優先度 | テストシナリオ |
|--------|--------|--------------|
| ユーザー登録 → 初回テスト完了 | P0 | 全世代モードでFTUEフロー完走 |
| デイリーチャレンジ実施 → スコア記録 | P0 | テスト実施 → スコア保存 → グラフ更新 |
| ファミリーグループ作成 → メンバー招待 | P0 | 招待リンク生成 → 受諾 → ダッシュボード表示 |
| ファミリーダッシュボード閲覧 | P0 | 全メンバーのスコア確認 → 傾向確認 |
| 励ましメッセージ送信 → 受信 | P1 | メッセージ作成 → 送信 → 受信通知 → 閲覧 |
| ヘルスレポート生成 → PDF出力 | P1 | レポート生成 → ダウンロード → 内容検証 |
| オフラインテスト → オンライン同期 | P1 | オフライン状態でテスト実施 → オンライン復帰 → 同期確認 |
| シニアモードUI切り替え | P1 | モード切り替え → UI変更確認（フォント、タッチターゲット） |
| アカウント削除 → データ消去 | P2 | 削除リクエスト → 猶予期間 → 完全消去確認 |

### NFR-009-03: アクセシビリティ自動テスト

| テスト項目 | ツール | 基準 |
|-----------|--------|------|
| WCAG 2.1 AA違反 | axe-core | 違反0件 |
| コントラスト比 | axe-core | 全テキスト4.5:1以上 |
| ARIA属性 | axe-core | 全インタラクティブ要素にラベル付き |
| キーボードナビゲーション | Playwright | 全操作フローをキーボードのみで完走 |
| スクリーンリーダー互換性 | 手動テスト（VoiceOver/TalkBack） | 月次実施 |
| タッチターゲットサイズ | カスタムルール | 44px以上（シニアモード: 56px以上） |

### NFR-009-04: パフォーマンスベンチマーク

| 測定項目 | ツール | 基準値 | 測定頻度 |
|---------|--------|--------|---------|
| Lighthouse Performance | Lighthouse CI | 90+ | 全デプロイ |
| Core Web Vitals | CrUX / Lighthouse | FCP < 1.8s, LCP < 2.5s, CLS < 0.1 | 全デプロイ |
| バンドルサイズ | `next build` 出力 | 初期JS < 100KB (gzip) | 全PR |
| API応答時間 | 負荷テスト（k6/Artillery） | p95 < 200ms | 月次 |
| メモリ使用量 | Chrome DevTools / Playwright | < 50MB | 月次 |
| 同時接続テスト | k6 | 500同時接続で応答劣化なし | 四半期 |

### NFR-009-05: CI/CDパイプライン統合

```
PR作成時:
  ├── TypeScript型チェック（tsc --noEmit）
  ├── ESLint + Prettier
  ├── ユニットテスト（Vitest）
  ├── コンポーネントテスト
  ├── アクセシビリティテスト（axe-core）
  ├── ビジュアルリグレッションテスト
  └── バンドルサイズチェック

デプロイ前（staging）:
  ├── 結合テスト
  ├── E2Eテスト（Playwright）
  ├── Lighthouse CI
  ├── モック検出（/mock-detector）
  └── UI品質チェック（/ui-skills）

デプロイ後（production）:
  ├── ヘルスチェック
  ├── スモークテスト（主要フロー確認）
  └── Synthetic Monitoring開始
```

---

## NFR-010: 運用・監視

### NFR-010-01: ヘルスチェック

| エンドポイント | チェック内容 | 間隔 | タイムアウト |
|--------------|------------|------|-----------|
| `GET /api/health` | アプリケーション起動状態 | 30秒 | 5秒 |
| `GET /api/health/db` | データベース接続 | 60秒 | 10秒 |
| `GET /api/health/cache` | Redis/ElastiCache接続 | 60秒 | 5秒 |
| `GET /api/health/external` | 外部API（CC-Auth等）接続 | 120秒 | 15秒 |

**レスポンス形式:**

```json
{
  "status": "healthy",
  "timestamp": "2026-02-15T10:00:00.000Z",
  "version": "1.0.0",
  "checks": {
    "database": { "status": "healthy", "latency_ms": 5 },
    "cache": { "status": "healthy", "latency_ms": 1 },
    "external_services": { "status": "healthy", "latency_ms": 45 }
  }
}
```

### NFR-010-02: ログ収集・管理

| ログ種別 | 収集方法 | 保持期間 | アラート連携 |
|---------|---------|---------|------------|
| アプリケーションログ | CloudWatch Logs | 90日間（S3アーカイブ: 1年） | エラーレート閾値超過時 |
| アクセスログ | ALB / CloudFront Logs | 90日間 | 異常アクセスパターン検知時 |
| エラーログ | CloudWatch Logs + Sentry | 90日間 | 全エラー即時通知 |
| 監査ログ | CloudWatch Logs（専用ロググループ） | 1年間 | 不正アクセス検知時 |
| パフォーマンスログ | CloudWatch Metrics | 1年間 | SLO違反時 |

**ログレベル:**

| レベル | 用途 | 本番環境出力 |
|--------|------|------------|
| ERROR | エラー・例外 | 常時出力 |
| WARN | 警告（パフォーマンス劣化、リトライ発生など） | 常時出力 |
| INFO | 重要なビジネスイベント（テスト完了、スコア記録など） | 常時出力 |
| DEBUG | デバッグ情報 | 無効（必要時のみ動的有効化） |

### NFR-010-03: メトリクス・ダッシュボード

| カテゴリ | メトリクス | ダッシュボード |
|---------|-----------|--------------|
| **インフラ** | CPU使用率、メモリ使用率、ディスクI/O、ネットワークスループット | CloudWatch ダッシュボード |
| **アプリケーション** | リクエスト数、エラーレート、レスポンスタイム（p50/p95/p99） | CloudWatch ダッシュボード |
| **ビジネス** | DAU、テスト完了数、テスト完了率、メッセージ送信数、新規登録数 | カスタムダッシュボード |
| **品質** | Core Web Vitals、Lighthouse スコア推移、エラーバジェット消費率 | カスタムダッシュボード |

### NFR-010-04: アラート設定

| アラート名 | 条件 | 通知先 | 重要度 |
|-----------|------|--------|--------|
| エラーレート急増 | 5分間のエラーレート > 5% | Slack + PagerDuty | Critical |
| レスポンスタイム劣化 | p95応答時間 > 500ms が5分継続 | Slack | High |
| CPU高負荷 | CPU使用率 > 80% が10分継続 | Slack | High |
| メモリ高使用率 | メモリ使用率 > 85% が5分継続 | Slack + PagerDuty | Critical |
| ディスク容量逼迫 | ディスク使用率 > 80% | Slack | Medium |
| ヘルスチェック失敗 | 連続3回失敗 | Slack + PagerDuty | Critical |
| 証明書期限切れ | 有効期限30日前 | Slack | Medium |
| DAU急減 | 前日比30%以上の減少 | Slack | Medium |
| バックアップ失敗 | 日次バックアップ失敗 | Slack + Email | High |
| セキュリティイベント | 不正ログイン試行5回以上 / 異常APIアクセス | Slack + PagerDuty | Critical |

### NFR-010-05: ユーザー行動分析

| 分析項目 | 収集データ | ツール | 目的 |
|---------|-----------|--------|------|
| テスト完了率 | テスト開始/完了イベント | カスタムイベント | 離脱ポイント特定 |
| 継続率 | ログイン/テスト実施ログ | カスタムイベント | リテンション改善 |
| 世代別利用パターン | 操作ログ + 世代情報 | カスタムイベント | 世代別UX最適化 |
| 機能利用率 | 各機能のアクセスログ | カスタムイベント | 機能優先度判断 |
| ファミリーインタラクション | メッセージ送信、ダッシュボード閲覧 | カスタムイベント | コミュニケーション促進施策 |

**プライバシー配慮:**

- 個人を特定しない匿名化データのみ分析
- オプトアウト機能を設定画面に配置
- データ収集の目的をプライバシーポリシーに明記
- 子供世代のデータは保護者同意のある場合のみ収集
- Cookie同意バナー: 初回アクセス時に表示

### NFR-010-06: インシデント対応

| フェーズ | 対応内容 | 目標時間 |
|---------|---------|---------|
| 検知 | アラート受信 → 担当者アサイン | < 5分 |
| トリアージ | 影響範囲・重要度判定 | < 15分 |
| 初期対応 | 暫定対策実施（スケールアウト、フォールバック） | < 30分 |
| 復旧 | サービス正常化確認 | < 1時間（SLA準拠） |
| ポストモーテム | 根本原因分析 → 再発防止策策定 | 72時間以内 |

---

## 技術スタック要件サマリ

| カテゴリ | 技術 | 非機能要件との関連 |
|---------|------|------------------|
| フレームワーク | Next.js (App Router) | SSR/SSG によるパフォーマンス最適化、SEO対応 |
| 言語 | TypeScript (strict mode) | 型安全性によるバグ予防、保守性向上 |
| スタイリング | Tailwind CSS v4 | パフォーマンス（PurgeCSS）、レスポンシブ、アクセシビリティ |
| アニメーション | motion/react | 60fps維持、`prefers-reduced-motion` 対応 |
| 状態管理 | Zustand | 軽量（バンドルサイズ）、オフラインステート管理 |
| PWA | Service Worker + IndexedDB | オフラインファースト、プッシュ通知 |
| テスト | Vitest + Playwright + axe-core | テスト戦略の全レイヤーカバー |
| 認証 | CC-Auth (AWS Cognito + JWT) | セキュリティ要件準拠 |
| CI/CD | GitHub Actions + CodePipeline | 自動テスト・自動デプロイ |
| インフラ | AWS (ECS Fargate, RDS, S3, CloudFront) | 可用性・スケーラビリティ |
| 監視 | CloudWatch + Sentry | 運用・監視要件準拠 |

---

## 受け入れ基準チェックリスト

### リリース前必須（全項目PASS必須）

- [ ] Lighthouse Performance: 90+
- [ ] Lighthouse Accessibility: 100
- [ ] Lighthouse Best Practices: 100
- [ ] Lighthouse SEO: 100
- [ ] Core Web Vitals: FCP < 1.8s, LCP < 2.5s, CLS < 0.1
- [ ] ユニットテストカバレッジ: 80%以上
- [ ] E2Eテスト: 主要フロー全PASS
- [ ] アクセシビリティテスト: axe-core違反0件
- [ ] WCAG 2.1 AA: 全ガイドライン準拠
- [ ] セキュリティヘッダー: 全て設定済み
- [ ] OWASP Top 10: 全対策実施
- [ ] オフラインテスト: テスト実施 → オンライン同期成功
- [ ] シニアモード: フォント20px以上、タッチターゲット56px以上
- [ ] エラーメッセージ: 全て日本語、技術用語なし
- [ ] 初回体験: 起動から初テスト完了まで5分以内
- [ ] バンドルサイズ: 初期JS < 100KB (gzip)
- [ ] モック/ダミーデータ: 本番コードに残存なし（/mock-detector PASS）

---

> **次のステップ:** [デザイン要件書](./design-requirements.md) の作成（Phase 1完了）
>
> **関連文書:**
> - [機能要件書](./requirements.md)
> - [デザイン要件書](./design-requirements.md)（作成予定）

---

*ドキュメント生成: CCAGI SDK Phase 1 - 要件定義*
