# æ©Ÿèƒ½ä»•æ§˜æ›¸: è„³æ´»ãƒ•ã‚¡ãƒŸãƒªãƒ¼

> **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
> **ä½œæˆæ—¥**: 2026-02-15
> **Phase**: 2 - è¨­è¨ˆ
> **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Draft
> **ã‚½ãƒ¼ã‚¹**: docs/requirements/requirements.md

---

## ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#1-ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
2. [ç”»é¢é·ç§»å›³](#2-ç”»é¢é·ç§»å›³)
3. [ã‚³ã‚¢æ©Ÿèƒ½ã®è©³ç´°ä»•æ§˜](#3-ã‚³ã‚¢æ©Ÿèƒ½ã®è©³ç´°ä»•æ§˜)
4. [Zustand Storeè¨­è¨ˆ](#4-zustand-storeè¨­è¨ˆ)
5. [ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æˆ¦ç•¥](#5-ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æˆ¦ç•¥)
6. [ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿](#6-ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿)

---

## 1. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.1 Next.js App Routeræ§‹æˆ

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx                    # RootLayout: ãƒ•ã‚©ãƒ³ãƒˆã€ãƒ†ãƒ¼ãƒã€Provider
â”‚   â”œâ”€â”€ page.tsx                      # "/" ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ (èªè¨¼çŠ¶æ…‹ã§åˆ†å²)
â”‚   â”œâ”€â”€ (auth)/                       # èªè¨¼ã‚°ãƒ«ãƒ¼ãƒ— (æœªãƒ­ã‚°ã‚¤ãƒ³)
â”‚   â”‚   â”œâ”€â”€ layout.tsx                # AuthLayout: ãƒ­ã‚´ã€æœ€å°UI
â”‚   â”‚   â”œâ”€â”€ login/page.tsx            # S-003: ãƒ­ã‚°ã‚¤ãƒ³
â”‚   â”‚   â”œâ”€â”€ register/page.tsx         # S-004: æ–°è¦ç™»éŒ²
â”‚   â”‚   â””â”€â”€ password-reset/page.tsx   # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
â”‚   â”œâ”€â”€ (onboarding)/                 # ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚°ãƒ«ãƒ¼ãƒ—
â”‚   â”‚   â”œâ”€â”€ layout.tsx                # OnboardingLayout: é€²æ—ãƒãƒ¼
â”‚   â”‚   â””â”€â”€ setup/
â”‚   â”‚       â””â”€â”€ [step]/page.tsx       # S-002: ã‚¹ãƒ†ãƒƒãƒ—1-5 å‹•çš„ãƒ«ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ (main)/                       # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚°ãƒ«ãƒ¼ãƒ— (ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆ)
â”‚   â”‚   â”œâ”€â”€ layout.tsx                # MainLayout: BottomNavã€é€šçŸ¥ãƒãƒŠãƒ¼
â”‚   â”‚   â”œâ”€â”€ home/page.tsx             # S-005: ãƒ›ãƒ¼ãƒ 
â”‚   â”‚   â”œâ”€â”€ challenge/
â”‚   â”‚   â”‚   â”œâ”€â”€ daily/page.tsx        # S-006: ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸
â”‚   â”‚   â”‚   â”œâ”€â”€ weekly/page.tsx       # S-020: ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸
â”‚   â”‚   â”‚   â””â”€â”€ [challengeId]/
â”‚   â”‚   â”‚       â”œâ”€â”€ play/page.tsx     # ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ç”»é¢
â”‚   â”‚   â”‚       â””â”€â”€ result/page.tsx   # S-007: ãƒ†ã‚¹ãƒˆçµæœ
â”‚   â”‚   â”œâ”€â”€ scores/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx              # S-008: ã‚¹ã‚³ã‚¢å±¥æ­´
â”‚   â”‚   â”œâ”€â”€ family/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx              # S-009: ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”‚   â”‚   â”œâ”€â”€ ranking/page.tsx      # S-010: ãƒ©ãƒ³ã‚­ãƒ³ã‚°
â”‚   â”‚   â”‚   â”œâ”€â”€ manage/page.tsx       # S-016: ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ join/page.tsx         # ã‚°ãƒ«ãƒ¼ãƒ—å‚åŠ 
â”‚   â”‚   â”œâ”€â”€ messages/page.tsx         # S-011: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
â”‚   â”‚   â”œâ”€â”€ badges/page.tsx           # S-012: ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”œâ”€â”€ character/page.tsx        # S-013: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç€ã›æ›¿ãˆ
â”‚   â”‚   â”œâ”€â”€ report/
â”‚   â”‚   â”‚   â””â”€â”€ [yearMonth]/page.tsx  # S-014: æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
â”‚   â”‚   â””â”€â”€ settings/
â”‚   â”‚       â”œâ”€â”€ page.tsx              # è¨­å®šãƒˆãƒƒãƒ—
â”‚   â”‚       â”œâ”€â”€ profile/page.tsx      # S-015: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š
â”‚   â”‚       â”œâ”€â”€ notifications/page.tsx # S-017: é€šçŸ¥è¨­å®š
â”‚   â”‚       â”œâ”€â”€ accessibility/page.tsx # S-018: ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®š
â”‚   â”‚       â””â”€â”€ privacy/page.tsx      # S-019: ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š
â”‚   â””â”€â”€ api/                          # API Routes (Route Handlers)
â”‚       â”œâ”€â”€ auth/
â”‚       â”œâ”€â”€ users/
â”‚       â”œâ”€â”€ families/
â”‚       â”œâ”€â”€ challenges/
â”‚       â”œâ”€â”€ scores/
â”‚       â”œâ”€â”€ messages/
â”‚       â”œâ”€â”€ gamification/
â”‚       â”œâ”€â”€ reports/
â”‚       â”œâ”€â”€ notifications/
â”‚       â”œâ”€â”€ data/
â”‚       â””â”€â”€ health/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                           # shadcn/ui ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ game/                         # ãƒ†ã‚¹ãƒˆã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ CardMatching.tsx          # çµµåˆã‚ã›
â”‚   â”‚   â”œâ”€â”€ WordMemory.tsx            # å˜èªè¨˜æ†¶
â”‚   â”‚   â”œâ”€â”€ StoryMemory.tsx           # ç‰©èªè¨˜æ†¶
â”‚   â”‚   â”œâ”€â”€ SpotDifference.tsx        # é–“é•ã„æ¢ã—
â”‚   â”‚   â”œâ”€â”€ StroopTest.tsx            # ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â”œâ”€â”€ ReactionTime.tsx          # åå¿œé€Ÿåº¦
â”‚   â”‚   â”œâ”€â”€ Shiritori.tsx             # ã—ã‚Šã¨ã‚Š
â”‚   â”‚   â”œâ”€â”€ Anagram.tsx               # ã‚¢ãƒŠã‚°ãƒ©ãƒ 
â”‚   â”‚   â”œâ”€â”€ WordAssociation.tsx       # é€£æƒ³ã‚²ãƒ¼ãƒ 
â”‚   â”‚   â”œâ”€â”€ MentalArithmetic.tsx      # æš—ç®—
â”‚   â”‚   â”œâ”€â”€ NumberSequence.tsx        # æ•°åˆ—
â”‚   â”‚   â”œâ”€â”€ JigsawPuzzle.tsx          # ã‚¸ã‚°ã‚½ãƒ¼ãƒ‘ã‚ºãƒ«
â”‚   â”‚   â”œâ”€â”€ ShapeRotation.tsx         # å›³å½¢å›è»¢
â”‚   â”‚   â””â”€â”€ GameTimer.tsx             # å…±é€šã‚¿ã‚¤ãƒãƒ¼
â”‚   â”œâ”€â”€ character/                    # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢é€£
â”‚   â”‚   â”œâ”€â”€ Mascot.tsx                # ã®ã†ãŸã‚“è¡¨ç¤º
â”‚   â”‚   â”œâ”€â”€ MascotAnimation.tsx       # ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
â”‚   â”‚   â””â”€â”€ CharacterDressUp.tsx      # ç€ã›æ›¿ãˆ
â”‚   â”œâ”€â”€ charts/                       # ã‚°ãƒ©ãƒ•é–¢é€£
â”‚   â”‚   â”œâ”€â”€ ScoreLineChart.tsx        # æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
â”‚   â”‚   â”œâ”€â”€ RadarChart.tsx            # ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
â”‚   â”‚   â””â”€â”€ CalendarHeatmap.tsx       # ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
â”‚   â”œâ”€â”€ family/                       # ãƒ•ã‚¡ãƒŸãƒªãƒ¼é–¢é€£
â”‚   â”‚   â”œâ”€â”€ MemberCard.tsx            # ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ RankingList.tsx           # ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ InviteDialog.tsx          # æ‹›å¾…ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
â”‚   â”œâ”€â”€ messages/                     # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£
â”‚   â”‚   â”œâ”€â”€ StampPicker.tsx           # ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠ
â”‚   â”‚   â”œâ”€â”€ VoiceRecorder.tsx         # éŸ³å£°éŒ²éŸ³
â”‚   â”‚   â””â”€â”€ VoicePlayer.tsx           # éŸ³å£°å†ç”Ÿ
â”‚   â””â”€â”€ layout/                       # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé–¢é€£
â”‚       â”œâ”€â”€ BottomNav.tsx             # ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”œâ”€â”€ Header.tsx                # ãƒ˜ãƒƒãƒ€ãƒ¼
â”‚       â””â”€â”€ NotificationBanner.tsx    # é€šçŸ¥ãƒãƒŠãƒ¼
â”œâ”€â”€ stores/                           # Zustand Store
â”‚   â”œâ”€â”€ userStore.ts
â”‚   â”œâ”€â”€ familyStore.ts
â”‚   â”œâ”€â”€ gameStore.ts
â”‚   â”œâ”€â”€ scoreStore.ts
â”‚   â”œâ”€â”€ messageStore.ts
â”‚   â””â”€â”€ characterStore.ts
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api/                          # APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ db/                           # IndexedDBæ“ä½œ
â”‚   â”œâ”€â”€ scoring/                      # ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”œâ”€â”€ difficulty/                   # é›£æ˜“åº¦èª¿æ•´ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”œâ”€â”€ sync/                         # ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸ
â”‚   â”œâ”€â”€ notifications/                # é€šçŸ¥ç®¡ç†
â”‚   â””â”€â”€ utils/                        # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ hooks/                            # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”œâ”€â”€ useGame.ts
â”‚   â”œâ”€â”€ useScore.ts
â”‚   â”œâ”€â”€ useFamily.ts
â”‚   â”œâ”€â”€ useOffline.ts
â”‚   â””â”€â”€ useAccessibility.ts
â””â”€â”€ types/                            # å‹å®šç¾©
    â”œâ”€â”€ user.ts
    â”œâ”€â”€ family.ts
    â”œâ”€â”€ game.ts
    â”œâ”€â”€ score.ts
    â”œâ”€â”€ message.ts
    â””â”€â”€ gamification.ts
```

### 1.2 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ/ã‚µãƒ¼ãƒãƒ¼ã®è²¬å‹™åˆ†é›¢

#### ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (RSC) ã®è²¬å‹™

| è²¬å‹™ | å…·ä½“ä¾‹ |
|------|--------|
| åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã€ã‚¹ã‚³ã‚¢å±¥æ­´ |
| SEOãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ | ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã€description |
| ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹ç¯‰ | ãƒšãƒ¼ã‚¸ã‚·ã‚§ãƒ«ã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€  |
| èªè¨¼ãƒã‚§ãƒƒã‚¯ | middleware.ts ã§ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆåˆ¶å¾¡ |
| æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ | PDFç”Ÿæˆã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç† |

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ("use client") ã®è²¬å‹™

| è²¬å‹™ | å…·ä½“ä¾‹ |
|------|--------|
| ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–UI | ãƒ†ã‚¹ãƒˆã‚²ãƒ¼ãƒ å…¨èˆ¬ã€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° | ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€é€šçŸ¥ |
| ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã€ç´™å¹é›ª |
| éŸ³å£°å‡¦ç† | ãƒœã‚¤ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éŒ²éŸ³/å†ç”Ÿã€éŸ³å£°ã‚¬ã‚¤ãƒ‰ |
| ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ | IndexedDBèª­ã¿æ›¸ãã€Service Workeré€šä¿¡ |
| çŠ¶æ…‹ç®¡ç† | Zustand Storeæ“ä½œå…¨èˆ¬ |
| ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ | ãƒ†ã‚¹ãƒˆåˆ¶é™æ™‚é–“ã€åå¿œé€Ÿåº¦è¨ˆæ¸¬ |

#### å¢ƒç•Œã®è¨­è¨ˆæŒ‡é‡

```
Server Component (ãƒ‡ãƒ¼ã‚¿å–å¾— + ã‚·ã‚§ãƒ«æç”»)
  â””â”€â”€ Client Component (ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³)
        â””â”€â”€ Server Component (é™çš„ãªå­è¦ç´ ã¯ children ã¨ã—ã¦æ¸¡ã™)
```

- Route Segment (`page.tsx`, `layout.tsx`) ã¯åŸå‰‡ Server Component
- `"use client"` ã¯å¯¾è©±ãŒå¿…è¦ãªæœ€å°ç¯„å›²ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ä»˜ä¸
- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã¯ Server Component ã§è¡Œã„ã€props ã¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¸¡ã™
- Zustand Store ã¸ã®ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ `StoreInitializer` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµŒç”±

### 1.3 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
[ãƒ–ãƒ©ã‚¦ã‚¶]
    â”‚
    â”œâ”€â”€ Service Worker â”€â”€â†’ Cache Storage (é™çš„ã‚¢ã‚»ãƒƒãƒˆ)
    â”‚       â”‚
    â”‚       â””â”€â”€ Background Sync â”€â”€â†’ Sync Queue (IndexedDB)
    â”‚
    â”œâ”€â”€ React App
    â”‚   â”œâ”€â”€ Server Components â”€â”€â†’ Next.js API Routes â”€â”€â†’ å¤–éƒ¨API/DB
    â”‚   â”‚                              â”‚
    â”‚   â”‚                              â”œâ”€â”€ POST /api/challenges/*/answer
    â”‚   â”‚                              â”œâ”€â”€ GET  /api/scores/me/summary
    â”‚   â”‚                              â””â”€â”€ ...
    â”‚   â”‚
    â”‚   â”œâ”€â”€ Client Components
    â”‚   â”‚   â”œâ”€â”€ Zustand Stores (ãƒ¡ãƒ¢ãƒªå†…çŠ¶æ…‹)
    â”‚   â”‚   â”‚   â”œâ”€â”€ userStore   â†â†’ localStorage (è¨­å®šæ°¸ç¶šåŒ–)
    â”‚   â”‚   â”‚   â”œâ”€â”€ gameStore   â†â†’ IndexedDB (ãƒ†ã‚¹ãƒˆé€²è¡ŒçŠ¶æ…‹)
    â”‚   â”‚   â”‚   â”œâ”€â”€ scoreStore  â†â†’ IndexedDB (ã‚¹ã‚³ã‚¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
    â”‚   â”‚   â”‚   â””â”€â”€ messageStore â†â†’ IndexedDB (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ Game Engine
    â”‚   â”‚   â”‚   â”œâ”€â”€ å•é¡Œç”Ÿæˆ â† API or ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    â”‚   â”‚   â”‚   â”œâ”€â”€ å›ç­”å—ä»˜ â†’ gameStore â†’ API
    â”‚   â”‚   â”‚   â”œâ”€â”€ ã‚¹ã‚³ã‚¢è¨ˆç®— â†’ scoreStore â†’ API
    â”‚   â”‚   â”‚   â””â”€â”€ é›£æ˜“åº¦èª¿æ•´ â†’ difficultyEngine â†’ API
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ Communication
    â”‚   â”‚       â”œâ”€â”€ Web Push API â† FCM/APNs
    â”‚   â”‚       â”œâ”€â”€ Polling (30ç§’) â†’ familyStoreæ›´æ–°
    â”‚   â”‚       â””â”€â”€ Voice â† MediaRecorder API
    â”‚   â”‚
    â”‚   â””â”€â”€ IndexedDB
    â”‚       â”œâ”€â”€ challenges (ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ãƒãƒ£ãƒ¬ãƒ³ã‚¸)
    â”‚       â”œâ”€â”€ scores (ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚³ã‚¢)
    â”‚       â”œâ”€â”€ messages (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
    â”‚       â””â”€â”€ syncQueue (æœªåŒæœŸãƒ‡ãƒ¼ã‚¿)
    â”‚
    â””â”€â”€ localStorage
        â”œâ”€â”€ auth_token (ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³)
        â”œâ”€â”€ user_settings (ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®š)
        â””â”€â”€ last_sync_timestamp
```

### 1.4 çŠ¶æ…‹ç®¡ç†è¨­è¨ˆï¼ˆZustand stores æ¦‚è¦ï¼‰

| Store | ä¸»è¦ãªçŠ¶æ…‹ | æ°¸ç¶šåŒ–å…ˆ | ç”¨é€” |
|-------|-----------|---------|------|
| `userStore` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€è¨­å®šã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ | localStorage | èªè¨¼ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»è¨­å®šç®¡ç† |
| `familyStore` | ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã€ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ | IndexedDB | ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ |
| `gameStore` | ãƒ†ã‚¹ãƒˆé€²è¡ŒçŠ¶æ…‹ã€å›ç­”ãƒ‡ãƒ¼ã‚¿ã€ã‚¿ã‚¤ãƒãƒ¼ | IndexedDB | ãƒ†ã‚¹ãƒˆã‚²ãƒ¼ãƒ é€²è¡Œç®¡ç† |
| `scoreStore` | ã‚¹ã‚³ã‚¢å±¥æ­´ã€ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã€ãƒˆãƒ¬ãƒ³ãƒ‰ | IndexedDB | ã‚¹ã‚³ã‚¢è¡¨ç¤ºãƒ»åˆ†æ |
| `messageStore` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã€æœªèª­æ•° | IndexedDB | ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ |
| `characterStore` | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çŠ¶æ…‹ã€ã‚³ã‚¤ãƒ³ã€ã‚¢ã‚¤ãƒ†ãƒ  | localStorage | ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ |

---

## 2. ç”»é¢é·ç§»å›³

### 2.1 å…¨ä½“é·ç§»å›³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ï¼‰

```
[ã‚¢ãƒ—ãƒªèµ·å‹•]
    â”‚
    â”œâ”€â”€ æœªèªè¨¼ â”€â”€â†’ S-001 ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥
    â”‚                â”‚
    â”‚                â”œâ”€â”€â†’ S-003 ãƒ­ã‚°ã‚¤ãƒ³ â†â”€â”€â†’ S-004 æ–°è¦ç™»éŒ²
    â”‚                â”‚       â”‚
    â”‚                â”‚       â”œâ”€â”€ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
    â”‚                â”‚       â”‚
    â”‚                â”‚       â””â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
    â”‚                â”‚               â”‚
    â”‚                â”‚               â”œâ”€â”€ åˆå› â”€â”€â†’ S-002 ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (Step 1-5)
    â”‚                â”‚               â”‚                â”‚
    â”‚                â”‚               â”‚                â””â”€â”€ å®Œäº† â”€â”€â†’ S-005 ãƒ›ãƒ¼ãƒ 
    â”‚                â”‚               â”‚
    â”‚                â”‚               â””â”€â”€ 2å›ç›®ä»¥é™ â”€â”€â†’ S-005 ãƒ›ãƒ¼ãƒ 
    â”‚                â”‚
    â”‚                â””â”€â”€ ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ (Google/Apple/LINE)
    â”‚                        â””â”€â”€ åŒä¸Šãƒ•ãƒ­ãƒ¼ã¸åˆæµ
    â”‚
    â””â”€â”€ èªè¨¼æ¸ˆ â”€â”€â†’ S-005 ãƒ›ãƒ¼ãƒ 
                    â”‚
                    â”œâ”€â”€ [BottomNav: ãƒ›ãƒ¼ãƒ ]
                    â”‚   â””â”€â”€ S-005 ãƒ›ãƒ¼ãƒ 
                    â”‚       â”œâ”€â”€â†’ S-006 ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                    â”‚       â”‚       â””â”€â”€â†’ ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ â”€â”€â†’ S-007 çµæœ
                    â”‚       â”œâ”€â”€â†’ S-020 ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                    â”‚       â”‚       â””â”€â”€â†’ ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ â”€â”€â†’ S-007 çµæœ
                    â”‚       â””â”€â”€â†’ S-008 ã‚¹ã‚³ã‚¢å±¥æ­´
                    â”‚
                    â”œâ”€â”€ [BottomNav: ãƒ•ã‚¡ãƒŸãƒªãƒ¼]
                    â”‚   â””â”€â”€ S-009 ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    â”‚       â”œâ”€â”€â†’ S-010 ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    â”‚       â”œâ”€â”€â†’ S-011 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    â”‚       â”œâ”€â”€â†’ S-016 ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
                    â”‚       â”‚       â””â”€â”€â†’ æ‹›å¾… (QR/ãƒªãƒ³ã‚¯/ã‚³ãƒ¼ãƒ‰)
                    â”‚       â””â”€â”€â†’ ãƒ¡ãƒ³ãƒãƒ¼è©³ç´° â”€â”€â†’ S-008 (ä»–è€…ã®ã‚¹ã‚³ã‚¢)
                    â”‚
                    â”œâ”€â”€ [BottomNav: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼]
                    â”‚   â”œâ”€â”€ S-012 ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
                    â”‚   â””â”€â”€ S-013 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç€ã›æ›¿ãˆ
                    â”‚
                    â”œâ”€â”€ [BottomNav: ãƒ¬ãƒãƒ¼ãƒˆ]
                    â”‚   â””â”€â”€ S-014 æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
                    â”‚
                    â””â”€â”€ [BottomNav: è¨­å®š]
                        â”œâ”€â”€ S-015 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š
                        â”œâ”€â”€ S-017 é€šçŸ¥è¨­å®š
                        â”œâ”€â”€ S-018 ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®š
                        â””â”€â”€ S-019 ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š
```

### 2.2 æ¡ä»¶åˆ†å²ã®è©³ç´°

| åˆ†å²ãƒã‚¤ãƒ³ãƒˆ | æ¡ä»¶ | é·ç§»å…ˆ |
|-------------|------|--------|
| ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ | èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹ | S-005 ãƒ›ãƒ¼ãƒ  |
| ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ | èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹/æœªèªè¨¼ | S-001 ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ â†’ S-003 ãƒ­ã‚°ã‚¤ãƒ³ |
| ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ | `isOnboardingCompleted === false` | S-002 ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚° |
| ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ | `isOnboardingCompleted === true` | S-005 ãƒ›ãƒ¼ãƒ  |
| ãƒ›ãƒ¼ãƒ ç”»é¢ | `ageGroup === 'senior' or 'senior_plus'` | ã‚·ãƒ‹ã‚¢UIï¼ˆå¤§æ–‡å­—ã€éŸ³å£°ã‚¬ã‚¤ãƒ‰ONï¼‰ |
| ãƒ›ãƒ¼ãƒ ç”»é¢ | `ageGroup === 'kids'` | ã‚­ãƒƒã‚ºUIï¼ˆã‚¤ãƒ©ã‚¹ãƒˆå¤šã‚ã€æ¼¢å­—å°‘ï¼‰ |
| ãƒ›ãƒ¼ãƒ ç”»é¢ | `simpleUiMode === true` | ã‚·ãƒ³ãƒ—ãƒ«UIï¼ˆè£…é£¾æ’é™¤ã€å¤§ãƒœã‚¿ãƒ³ï¼‰ |
| ãƒ†ã‚¹ãƒˆçµæœç”»é¢ | `score >= previousBest` | æ–°è¨˜éŒ²æ¼”å‡º + ç´™å¹é›ª |
| ãƒ†ã‚¹ãƒˆçµæœç”»é¢ | `score < previousBest` | åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | ãƒ•ã‚¡ãƒŸãƒªãƒ¼æœªå‚åŠ  | ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ/å‚åŠ ç”»é¢ã¸èª˜å° |
| æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ | å½“æœˆãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼ˆãƒ†ã‚¹ãƒˆ5æ—¥æœªæº€ï¼‰ | ã€Œãƒ‡ãƒ¼ã‚¿åé›†ä¸­ã€è¡¨ç¤º |
| ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­ | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒŠãƒ¼è¡¨ç¤ºã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œ |

### 2.3 BottomNavæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ›ãƒ¼ãƒ   â”‚ ãƒ•ã‚¡ãƒŸãƒªãƒ¼ â”‚ ã‚­ãƒ£ãƒ©  â”‚ ãƒ¬ãƒãƒ¼ãƒˆ â”‚ è¨­å®š  â”‚
â”‚   ğŸ     â”‚    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦    â”‚   ğŸ¦‰   â”‚   ğŸ“Š   â”‚  âš™ï¸  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–: ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
- æœªèª­ãƒãƒƒã‚¸: ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚¿ãƒ–ã«æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’è¡¨ç¤º
- ã‚·ãƒ‹ã‚¢ãƒ¢ãƒ¼ãƒ‰: ã‚¢ã‚¤ã‚³ãƒ³ + ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ™ãƒ«ä½µè¨˜ã€ã‚µã‚¤ã‚ºæ‹¡å¤§

---

## 3. ã‚³ã‚¢æ©Ÿèƒ½ã®è©³ç´°ä»•æ§˜

### 3.1 èªçŸ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ã‚¸ãƒ³

#### 3.1.1 ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã”ã¨ã®ãƒ«ãƒ¼ãƒ«ã¨ã‚¹ã‚³ã‚¢è¨ˆç®—

##### a) è¨˜æ†¶åŠ›ãƒ†ã‚¹ãƒˆ

**çµµåˆã‚ã›ï¼ˆç¥çµŒè¡°å¼±ï¼‰**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| ã‚«ãƒ¼ãƒ‰æšæ•° | 6 (2x3) | 12 (3x4) | 16 (4x4) | 12 (3x4) | 20 (4x5) |
| ãƒšã‚¢æ•° | 3 | 6 | 8 | 6 | 10 |
| åˆ¶é™æ™‚é–“(ç§’) | 60 | 90 | 120 | 120 | 180 |
| ãƒ’ãƒ³ãƒˆ | ãªã— | ãªã— | ãªã— | åˆå›1ãƒšã‚¢è¡¨ç¤º | ãªã— |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  base_score = (ç™ºè¦‹ãƒšã‚¢æ•° / ç·ãƒšã‚¢æ•°) * 100
  efficiency = max(0, 1 - (è©¦è¡Œå›æ•° - æœ€å°è©¦è¡Œå›æ•°) / (æœ€å¤§è©¦è¡Œå›æ•° - æœ€å°è©¦è¡Œå›æ•°))
  time_bonus = max(0, (åˆ¶é™æ™‚é–“ - æ‰€è¦æ™‚é–“) / åˆ¶é™æ™‚é–“) * 0.2
  score = base_score * 0.6 + efficiency * 100 * 0.25 + time_bonus * 100 * 0.15

  æœ€å°è©¦è¡Œå›æ•° = ãƒšã‚¢æ•° (å®Œå…¨è¨˜æ†¶ã®å ´åˆ)
  æœ€å¤§è©¦è¡Œå›æ•° = ãƒšã‚¢æ•° * 4 (ãƒ©ãƒ³ãƒ€ãƒ æ¨æ¸¬ã®æœŸå¾…å€¤)
```

**å˜èªè¨˜æ†¶**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| å˜èªæ•° | 3 | 5 | 7 | 5 | 10 |
| è¡¨ç¤ºæ™‚é–“(ç§’) | 9 | 15 | 21 | 15 | 30 |
| å›ç­”æ™‚é–“(ç§’) | 30 | 45 | 60 | 60 | 90 |
| è£œåŠ© | ã‚¤ãƒ©ã‚¹ãƒˆä»˜ã | ãªã— | ãªã— | ã‚«ãƒ†ã‚´ãƒªãƒ’ãƒ³ãƒˆ | ãªã— |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  recall_score = (æ­£ç­”å˜èªæ•° / ç·å˜èªæ•°) * 100
  order_bonus = (é †åºæ­£ç­”æ•° / ç·å˜èªæ•°) * 20
  score = min(100, recall_score * 0.8 + order_bonus)
```

**ç‰©èªè¨˜æ†¶**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| æ–‡ç« æ•° | 2 | 3 | 5 | 3 | 7 |
| è³ªå•æ•° | 2 | 3 | 5 | 3 | 7 |
| èª­è§£æ™‚é–“(ç§’) | 20 | 30 | 50 | 40 | 70 |
| å›ç­”æ™‚é–“(ç§’/å•) | 15 | 12 | 10 | 15 | 8 |
| è£œåŠ© | ã‚¤ãƒ©ã‚¹ãƒˆ | ãªã— | ãªã— | éŸ³å£°èª­ã¿ä¸Šã’ | ãªã— |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  accuracy = (æ­£ç­”æ•° / è³ªå•æ•°) * 100
  speed_factor = avg(max(0, 1 - å›ç­”æ™‚é–“ / åˆ¶é™æ™‚é–“) for each question)
  score = accuracy * 0.85 + speed_factor * 100 * 0.15
```

##### b) æ³¨æ„åŠ›ãƒ†ã‚¹ãƒˆ

**é–“é•ã„æ¢ã—**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| é•ã„ç®‡æ‰€æ•° | 3 | 5 | 7 | 4 | 10 |
| åˆ¶é™æ™‚é–“(ç§’) | 60 | 90 | 90 | 90 | 120 |
| é•ã„ã®ã‚µã‚¤ã‚º | å¤§ | ä¸­ | å° | ä¸­+ã‚¾ãƒ¼ãƒ³ãƒ’ãƒ³ãƒˆ | æ¥µå° |
| èª¤ã‚¿ãƒƒãƒ—è¨±å®¹ | 5å› | 3å› | 3å› | 5å› | 2å› |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  found_ratio = ç™ºè¦‹æ•° / ç·é•ã„æ•°
  penalty = èª¤ã‚¿ãƒƒãƒ—æ•° * 5
  time_bonus = max(0, (åˆ¶é™æ™‚é–“ - æ‰€è¦æ™‚é–“) / åˆ¶é™æ™‚é–“) * 15
  score = max(0, found_ratio * 100 * 0.7 - penalty + time_bonus)
```

**ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å…¨é›£æ˜“åº¦å…±é€š |
|-----------|------------|
| å•é¡Œæ•° | 20 |
| 1å•åˆ¶é™æ™‚é–“(ç§’) | 3 |
| è‰²æ•° | 4è‰²ï¼ˆèµ¤ã€é’ã€ç·‘ã€é»„ï¼‰ |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  accuracy = æ­£ç­”æ•° / 20 * 100
  avg_reaction = å¹³å‡æ­£ç­”åå¿œæ™‚é–“ (ms)
  speed_score = max(0, (3000 - avg_reaction) / 3000) * 100
  score = accuracy * 0.6 + speed_score * 0.4
```

**åå¿œé€Ÿåº¦ãƒ†ã‚¹ãƒˆ**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå‡ºç¾å›æ•° | 15 | 20 | 25 | 15 | 30 |
| ãŠã¨ã‚Šå‡ºç¾å›æ•° | 5 | 10 | 15 | 5 | 20 |
| è¡¨ç¤ºé–“éš”(ms) | 1500-3000 | 1000-2500 | 800-2000 | 1500-3000 | 500-1500 |
| åå¿œè¨±å®¹æ™‚é–“(ms) | 1500 | 1000 | 800 | 1500 | 600 |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  hit_rate = æ­£ã—ã„ã‚¿ãƒƒãƒ—æ•° / ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°
  false_alarm_rate = èª¤ã‚¿ãƒƒãƒ—æ•° / ãŠã¨ã‚Šæ•°
  avg_rt = æ­£ç­”ã®å¹³å‡åå¿œæ™‚é–“ (ms)

  accuracy_score = (hit_rate - false_alarm_rate) * 100
  speed_score = max(0, (åå¿œè¨±å®¹æ™‚é–“ - avg_rt) / åå¿œè¨±å®¹æ™‚é–“) * 100
  score = max(0, accuracy_score * 0.5 + speed_score * 0.5)
```

##### c) è¨€èªåŠ›ãƒ†ã‚¹ãƒˆ

**ã—ã‚Šã¨ã‚Šï¼ˆAIå¯¾æˆ¦ï¼‰**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| åˆ¶é™æ™‚é–“(ç§’/ã‚¿ãƒ¼ãƒ³) | 30 | 20 | 15 | 25 | 10 |
| AIèªå½™ãƒ¬ãƒ™ãƒ« | å°å­¦1-3å¹´ | å°å­¦4-6å¹´ | ä¸€èˆ¬ | ä¸€èˆ¬(ã‚†ã£ãã‚Š) | å°‚é–€èªå½™å«ã‚€ |
| æœ€å¤§ã‚¿ãƒ¼ãƒ³æ•° | 10 | 15 | 20 | 15 | 25 |
| éŸ³å£°å…¥åŠ› | å¯¾å¿œ | å¯¾å¿œ | å¯¾å¿œ | å¯¾å¿œ(æ¨å¥¨) | å¯¾å¿œ |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  turns_survived = è‡ªåˆ†ãŒå›ç­”ã§ããŸã‚¿ãƒ¼ãƒ³æ•°
  max_turns = æœ€å¤§ã‚¿ãƒ¼ãƒ³æ•° / 2 (è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³æ•°)
  avg_time = å¹³å‡å›ç­”æ™‚é–“
  unique_chars = ä½¿ç”¨ã—ãŸé ­æ–‡å­—ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æ•°

  survival_score = (turns_survived / max_turns) * 100
  speed_bonus = max(0, (åˆ¶é™æ™‚é–“ - avg_time) / åˆ¶é™æ™‚é–“) * 15
  variety_bonus = min(10, unique_chars * 2)
  score = min(100, survival_score * 0.75 + speed_bonus + variety_bonus)
```

**ã‚¢ãƒŠã‚°ãƒ©ãƒ ï¼ˆæ–‡å­—ä¸¦ã¹æ›¿ãˆï¼‰**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| æ–‡å­—æ•° | 2-3 | 4-5 | 5-6 | 3-4 | 6-8 |
| å•é¡Œæ•° | 5 | 7 | 10 | 5 | 10 |
| 1å•åˆ¶é™æ™‚é–“(ç§’) | 30 | 25 | 20 | 30 | 15 |
| ãƒ’ãƒ³ãƒˆ | ãªã— | ãªã— | ãªã— | æœ€åˆã®1æ–‡å­— | ãªã— |
| æ–‡å­—ç¨® | ã²ã‚‰ãŒãª | ã²ã‚‰ãŒãª | ã²ã‚‰ãŒãª+ã‚«ã‚¿ã‚«ãƒŠ | ã²ã‚‰ãŒãª | æ¼¢å­—æ··åœ¨ |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  accuracy = æ­£ç­”æ•° / å•é¡Œæ•° * 100
  avg_time = å¹³å‡æ­£ç­”æ™‚é–“
  speed_factor = max(0, (åˆ¶é™æ™‚é–“ - avg_time) / åˆ¶é™æ™‚é–“)
  score = accuracy * 0.7 + speed_factor * 100 * 0.3
```

**é€£æƒ³ã‚²ãƒ¼ãƒ **

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| åˆ¶é™æ™‚é–“(ç§’) | 60 | 60 | 60 | 90 | 45 |
| ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•° | 1 | 2 | 3 | 1 | 3 |
| å…¥åŠ›æ–¹å¼ | ãƒ†ã‚­ã‚¹ãƒˆ+éŸ³å£° | ãƒ†ã‚­ã‚¹ãƒˆ+éŸ³å£° | ãƒ†ã‚­ã‚¹ãƒˆ+éŸ³å£° | éŸ³å£°æ¨å¥¨ | ãƒ†ã‚­ã‚¹ãƒˆ+éŸ³å£° |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  valid_words = æœ‰åŠ¹å›ç­”æ•° (è¾æ›¸ã«å­˜åœ¨ã—ã€ãƒ†ãƒ¼ãƒã«é–¢é€£)
  expected_words = å¹´é½¢å±¤åˆ¥æœŸå¾…å€¤ (ã‚­ãƒƒã‚º:5, ã‚¸ãƒ¥ãƒ‹ã‚¢:8, ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰:12, ã‚·ãƒ‹ã‚¢:6, ãƒãƒ£ãƒ¬ãƒ³ã‚¸:15)

  quantity_score = min(100, (valid_words / expected_words) * 100)
  variety_score = ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚«ãƒ†ã‚´ãƒªæ•° * 10  // å¤šæ§˜ãªè¦³ç‚¹ã‹ã‚‰é€£æƒ³ã—ã¦ã„ã‚‹ã‹
  score = min(100, quantity_score * 0.7 + variety_score * 0.3)
```

##### d) è¨ˆç®—åŠ›ãƒ†ã‚¹ãƒˆ

**æš—ç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| æ¼”ç®—ç¨®åˆ¥ | +, - | +, -, Ã—, Ã· | +, -, Ã—, Ã· | +, - | è¤‡åˆ(æ‹¬å¼§ä»˜ã) |
| æ¡æ•° | 1æ¡ | 2æ¡ | 3æ¡ | 2æ¡ | 3æ¡+è¤‡åˆ |
| å•é¡Œæ•° | 10 | 10 | 15 | 10 | 15 |
| 1å•åˆ¶é™æ™‚é–“(ç§’) | 15 | 10 | 8 | 12 | 6 |
| è¡¨ç¤ºã‚µã‚¤ã‚º | å¤§ | æ¨™æº– | æ¨™æº– | ç‰¹å¤§ | æ¨™æº– |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  accuracy = æ­£ç­”æ•° / å•é¡Œæ•° * 100
  avg_time = å¹³å‡æ­£ç­”æ™‚é–“
  speed_factor = max(0, (åˆ¶é™æ™‚é–“ - avg_time) / åˆ¶é™æ™‚é–“)
  difficulty_weight = [0.8, 0.9, 1.0, 0.9, 1.2][é›£æ˜“åº¦ - 1]
  score = (accuracy * 0.6 + speed_factor * 100 * 0.4) * difficulty_weight
  score = min(100, score)
```

**æ•°åˆ—ãƒ‘ã‚¿ãƒ¼ãƒ³**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| ãƒ‘ã‚¿ãƒ¼ãƒ³ç¨®åˆ¥ | ç­‰å·® | ç­‰å·®,ç­‰æ¯” | ç­‰å·®,ç­‰æ¯”,è¤‡åˆ | ç­‰å·® | ãƒ•ã‚£ãƒœãƒŠãƒƒãƒå‹å«ã‚€ |
| æç¤ºæ•°åˆ—é•· | 4 | 5 | 5 | 4 | 6 |
| å•é¡Œæ•° | 5 | 7 | 10 | 5 | 10 |
| 1å•åˆ¶é™æ™‚é–“(ç§’) | 20 | 15 | 12 | 20 | 10 |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  accuracy = æ­£ç­”æ•° / å•é¡Œæ•° * 100
  speed_bonus = avg(max(0, (åˆ¶é™æ™‚é–“ - å›ç­”æ™‚é–“) / åˆ¶é™æ™‚é–“)) * 20
  score = min(100, accuracy * 0.8 + speed_bonus)
```

##### e) ç©ºé–“èªè­˜ãƒ†ã‚¹ãƒˆ

**ã‚¸ã‚°ã‚½ãƒ¼ãƒ‘ã‚ºãƒ«**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| ãƒ”ãƒ¼ã‚¹æ•° | 4 (2x2) | 9 (3x3) | 16 (4x4) | 6 (2x3) | 25 (5x5) |
| åˆ¶é™æ™‚é–“(ç§’) | 60 | 120 | 180 | 120 | 240 |
| ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ | ãªã— | ãªã— | ãªã— | æ ç·šè¡¨ç¤º | ãªã— |
| å›è»¢æ“ä½œ | ãªã— | ãªã— | ã‚ã‚Š | ãªã— | ã‚ã‚Š |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  completion = æ­£ã—ãé…ç½®ã—ãŸãƒ”ãƒ¼ã‚¹æ•° / ç·ãƒ”ãƒ¼ã‚¹æ•°
  time_factor = max(0, (åˆ¶é™æ™‚é–“ - æ‰€è¦æ™‚é–“) / åˆ¶é™æ™‚é–“)
  move_efficiency = æœ€å°ç§»å‹•å›æ•° / å®Ÿéš›ã®ç§»å‹•å›æ•°
  score = completion * 100 * 0.5 + time_factor * 100 * 0.25 + move_efficiency * 100 * 0.25
```

**å›³å½¢å›è»¢**

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ãƒãƒ£ãƒ¬ãƒ³ã‚¸ |
|-----------|--------|---------|------------|--------|----------|
| å›è»¢æ¬¡å…ƒ | 2D | 2D | 2D+3D | 2D | 3D |
| å•é¡Œæ•° | 5 | 8 | 10 | 5 | 10 |
| é¸æŠè‚¢æ•° | 3 | 4 | 4 | 3 | 5 |
| 1å•åˆ¶é™æ™‚é–“(ç§’) | 20 | 15 | 12 | 20 | 10 |
| å›è»¢è§’åº¦ | 90åº¦ã®ã¿ | 90/180åº¦ | ä»»æ„è§’åº¦ | 90åº¦ã®ã¿ | ä»»æ„+åè»¢ |

```
ã‚¹ã‚³ã‚¢è¨ˆç®—:
  accuracy = æ­£ç­”æ•° / å•é¡Œæ•° * 100
  speed_bonus = avg(max(0, (åˆ¶é™æ™‚é–“ - å›ç­”æ™‚é–“) / åˆ¶é™æ™‚é–“)) * 20
  score = min(100, accuracy * 0.8 + speed_bonus)
```

#### 3.1.2 é›£æ˜“åº¦èª¿æ•´ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```typescript
function adjustDifficulty(
  currentLevel: DifficultyLevel,
  recentResults: TestResult[] // ç›´è¿‘5å›
): DifficultyLevel {
  // ç›´è¿‘5å›ã®çµæœãŒä¸è¶³ã™ã‚‹å ´åˆã¯ç¾åœ¨ãƒ¬ãƒ™ãƒ«ç¶­æŒ
  if (recentResults.length < 2) return currentLevel;

  const recentAccuracies = recentResults.map(r => r.accuracy);

  // æ˜‡æ ¼æ¡ä»¶: ç›´è¿‘3å›é€£ç¶šã§æ­£ç­”ç‡80%ä»¥ä¸Š
  const lastThree = recentAccuracies.slice(-3);
  if (lastThree.length >= 3 && lastThree.every(a => a >= 80)) {
    return Math.min(5, currentLevel + 1) as DifficultyLevel;
  }

  // é™æ ¼æ¡ä»¶: ç›´è¿‘2å›é€£ç¶šã§æ­£ç­”ç‡40%ä»¥ä¸‹
  const lastTwo = recentAccuracies.slice(-2);
  if (lastTwo.length >= 2 && lastTwo.every(a => a <= 40)) {
    return Math.max(1, currentLevel - 1) as DifficultyLevel;
  }

  return currentLevel;
}
```

**é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã¨å¹´é½¢å±¤ã®åˆæœŸå¯¾å¿œãƒ†ãƒ¼ãƒ–ãƒ«:**

| å¹´é½¢å±¤ | åˆæœŸé›£æ˜“åº¦ | èª¬æ˜ |
|--------|----------|------|
| ã‚­ãƒƒã‚º (5-12æ­³) | Level 1 | ã‚¤ãƒ©ã‚¹ãƒˆä»˜ãã€å°‘ãªã„å•é¡Œæ•° |
| ã‚¸ãƒ¥ãƒ‹ã‚¢ (13-19æ­³) | Level 2 | æ¨™æº–çš„ãªå‡ºé¡Œ |
| ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ (20-59æ­³) | Level 3 | ãƒ•ãƒ«æ©Ÿèƒ½ã®å‡ºé¡Œ |
| ã‚·ãƒ‹ã‚¢ (60-74æ­³) | Level 4 | ãƒ’ãƒ³ãƒˆä»˜ãã€å¤§ããªè¡¨ç¤º |
| ã‚·ãƒ‹ã‚¢ãƒ—ãƒ©ã‚¹ (75æ­³ä»¥ä¸Š) | Level 4 | åŒä¸Š + éŸ³å£°ã‚¬ã‚¤ãƒ‰è‡ªå‹•ON |

- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ç‹¬ç«‹ã—ãŸé›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã‚’ä¿æŒã™ã‚‹
- ä¾‹: è¨˜æ†¶åŠ›=Level 3ã€è¨ˆç®—åŠ›=Level 2 ã®ã‚ˆã†ã«å€‹åˆ¥ç®¡ç†

#### 3.1.3 å¹´é½¢åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ã‚­ãƒƒã‚º | ã‚¸ãƒ¥ãƒ‹ã‚¢ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ã‚·ãƒ‹ã‚¢ | ã‚·ãƒ‹ã‚¢ãƒ—ãƒ©ã‚¹ |
|-----------|--------|---------|------------|--------|------------|
| åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º | 18px | 16px | 16px | 20px | 24px |
| ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ | 52px | 44px | 44px | 56px | 64px |
| ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦ | 1.0x | 1.0x | 1.0x | 0.8x | 0.6x |
| éŸ³å£°ã‚¬ã‚¤ãƒ‰ | OFF | OFF | OFF | ON(æ¨å¥¨) | ON(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) |
| ãƒ’ãƒ³ãƒˆè¡¨ç¤º | ã‚ã‚Š | ãªã— | ãªã— | ã‚ã‚Š | ã‚ã‚Š(è‡ªå‹•) |
| åˆ¶é™æ™‚é–“ä¿‚æ•° | 1.2x | 1.0x | 1.0x | 1.3x | 1.5x |
| æ¼¢å­—ä½¿ç”¨ | ãªã— | åŸºæœ¬æ¼¢å­— | é€šå¸¸ | é€šå¸¸(ãƒ«ãƒ“ä»˜ã) | é€šå¸¸(ãƒ«ãƒ“ä»˜ã) |
| çµæœè¡¨ç¾ | ãƒã‚¸ãƒ†ã‚£ãƒ–ã®ã¿ | é€šå¸¸ | é€šå¸¸ | ãƒã‚¸ãƒ†ã‚£ãƒ–ã®ã¿ | ãƒã‚¸ãƒ†ã‚£ãƒ–ã®ã¿ |

### 3.2 ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

#### 3.2.1 ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚³ã‚¢ç®—å‡ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ0-100æ­£è¦åŒ–ï¼‰

å„ãƒ†ã‚¹ãƒˆã® raw score ã‚’0-100ã®ç¯„å›²ã«æ­£è¦åŒ–ã™ã‚‹å…±é€šé–¢æ•°:

```typescript
function normalizeScore(rawScore: number, min: number, max: number): number {
  return Math.round(Math.max(0, Math.min(100, ((rawScore - min) / (max - min)) * 100)));
}
```

ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢ã¯ã€ãã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹è¤‡æ•°ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã®ã‚¹ã‚³ã‚¢ã‚’åŠ é‡å¹³å‡ã—ã¦ç®—å‡º:

```typescript
const CATEGORY_WEIGHTS: Record<TestCategory, Record<string, number>> = {
  memory: {
    card_matching: 0.35,
    word_memory: 0.35,
    story_memory: 0.30,
  },
  attention: {
    spot_difference: 0.30,
    stroop: 0.35,
    reaction_time: 0.35,
  },
  language: {
    shiritori: 0.30,
    anagram: 0.35,
    word_association: 0.35,
  },
  calculation: {
    mental_arithmetic: 0.60,
    number_sequence: 0.40,
  },
  spatial: {
    jigsaw_puzzle: 0.50,
    shape_rotation: 0.50,
  },
};

function calculateCategoryScore(
  category: TestCategory,
  testScores: Record<string, number>
): number {
  const weights = CATEGORY_WEIGHTS[category];
  let totalWeight = 0;
  let weightedSum = 0;

  for (const [testType, weight] of Object.entries(weights)) {
    if (testScores[testType] !== undefined) {
      weightedSum += testScores[testType] * weight;
      totalWeight += weight;
    }
  }

  return totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0;
}
```

#### 3.2.2 ç·åˆã‚¹ã‚³ã‚¢ç®—å‡ºï¼ˆé‡ã¿ä»˜ã‘å¹³å‡ï¼‰

```typescript
const TOTAL_SCORE_WEIGHTS: Record<TestCategory, number> = {
  memory: 0.25,      // è¨˜æ†¶åŠ›: èªçŸ¥ç—‡äºˆé˜²ã®æœ€é‡è¦æŒ‡æ¨™
  attention: 0.20,   // æ³¨æ„åŠ›
  language: 0.20,    // è¨€èªåŠ›
  calculation: 0.15, // è¨ˆç®—åŠ›
  spatial: 0.20,     // ç©ºé–“èªè­˜
};

function calculateTotalScore(categoryScores: CategoryScores): number {
  let totalWeight = 0;
  let weightedSum = 0;

  for (const [category, weight] of Object.entries(TOTAL_SCORE_WEIGHTS)) {
    const score = categoryScores[category as TestCategory];
    if (score !== undefined && score > 0) {
      weightedSum += score * weight;
      totalWeight += weight;
    }
  }

  return totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0;
}
```

#### 3.2.3 ãƒˆãƒ¬ãƒ³ãƒ‰è¨ˆç®—

```typescript
interface TrendData {
  direction: 'improving' | 'stable' | 'declining';
  changePercent: number;
  movingAverage2w: number;  // 2é€±é–“ç§»å‹•å¹³å‡
  movingAverage4w: number;  // 4é€±é–“ç§»å‹•å¹³å‡
  standardDeviation: number;
}

function calculateTrend(scores: { date: string; score: number }[]): TrendData {
  const twoWeeksAgo = subDays(new Date(), 14);
  const fourWeeksAgo = subDays(new Date(), 28);

  const recent2w = scores.filter(s => new Date(s.date) >= twoWeeksAgo);
  const recent4w = scores.filter(s => new Date(s.date) >= fourWeeksAgo);

  const avg2w = average(recent2w.map(s => s.score));
  const avg4w = average(recent4w.map(s => s.score));

  const changePercent = avg4w > 0 ? ((avg2w - avg4w) / avg4w) * 100 : 0;

  // æ¨™æº–åå·®ã®è¨ˆç®—
  const allScores = scores.map(s => s.score);
  const mean = average(allScores);
  const variance = allScores.reduce((sum, s) => sum + Math.pow(s - mean, 2), 0) / allScores.length;
  const stdDev = Math.sqrt(variance);

  let direction: TrendData['direction'];
  if (changePercent > 5) direction = 'improving';
  else if (changePercent < -5) direction = 'declining';
  else direction = 'stable';

  return {
    direction,
    changePercent: Math.round(changePercent * 10) / 10,
    movingAverage2w: Math.round(avg2w * 10) / 10,
    movingAverage4w: Math.round(avg4w * 10) / 10,
    standardDeviation: Math.round(stdDev * 10) / 10,
  };
}
```

#### 3.2.4 æ—©æœŸè­¦å‘Šã®é–¾å€¤å®šç¾©

```typescript
const ALERT_THRESHOLDS = {
  // æ³¨æ„ (caution): 1ã‚«ãƒ†ã‚´ãƒªã§è»½åº¦ã®å¤‰åŒ–
  caution: {
    scoreDropPercent: 10,       // 2é€±é–“å¹³å‡ãŒå‰æœˆæ¯”10%ä»¥ä¸Šä½ä¸‹
    consecutiveLows: 2,         // 2å›é€£ç¶šã§éå»å¹³å‡ä»¥ä¸‹
    inactiveDays: 5,            // 5æ—¥ä»¥ä¸Šãƒ†ã‚¹ãƒˆæœªå®Ÿæ–½
    gracePeriodDays: 3,         // çŒ¶äºˆæœŸé–“
  },
  // è­¦æˆ’ (warning): è¤‡æ•°ã‚«ãƒ†ã‚´ãƒªã§ä¸­åº¦ã®å¤‰åŒ–
  warning: {
    scoreDropPercent: 15,       // 2é€±é–“å¹³å‡ãŒå‰æœˆæ¯”15%ä»¥ä¸Šä½ä¸‹
    categoriesAffected: 2,      // 2ã‚«ãƒ†ã‚´ãƒªä»¥ä¸Šã§ä½ä¸‹
    consecutiveLows: 3,         // 3å›é€£ç¶šã§éå»æœ€ä½ã‚’è¨˜éŒ²
    inactiveDays: 7,            // 7æ—¥ä»¥ä¸Šãƒ†ã‚¹ãƒˆæœªå®Ÿæ–½
    gracePeriodDays: 3,
  },
  // è¦ç¢ºèª (attention): ç·åˆã‚¹ã‚³ã‚¢ã®é¡•è‘—ãªä½ä¸‹
  attention: {
    scoreDropPercent: 20,       // 2é€±é–“å¹³å‡ãŒå‰æœˆæ¯”20%ä»¥ä¸Šä½ä¸‹
    stdDeviation: 2,            // æ¨™æº–åå·®2Ïƒä»¥ä¸Šã®å¤‰åŒ–
    categoriesAffected: 3,      // 3ã‚«ãƒ†ã‚´ãƒªä»¥ä¸Šã§ä½ä¸‹
    inactiveDays: 10,           // 10æ—¥ä»¥ä¸Šãƒ†ã‚¹ãƒˆæœªå®Ÿæ–½
    gracePeriodDays: 3,
  },
};
```

### 3.3 ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—

#### 3.3.1 æ‹›å¾…ãƒ•ãƒ­ãƒ¼

```
[ç®¡ç†è€…] ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ç”»é¢
    â”‚
    â”œâ”€â”€ QRã‚³ãƒ¼ãƒ‰æ–¹å¼
    â”‚   â”œâ”€â”€ ã€ŒQRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—
    â”‚   â”œâ”€â”€ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (å†…å®¹: https://app.example.com/family/join?code=XXXXXX)
    â”‚   â”œâ”€â”€ [å‚åŠ è€…] ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³
    â”‚   â”œâ”€â”€ ã‚¢ãƒ—ãƒªå†…å‚åŠ ç¢ºèªç”»é¢è¡¨ç¤º
    â”‚   â””â”€â”€ ã€Œå‚åŠ ã™ã‚‹ã€ã‚¿ãƒƒãƒ— â†’ å‚åŠ å®Œäº†
    â”‚
    â”œâ”€â”€ æ‹›å¾…ãƒªãƒ³ã‚¯æ–¹å¼
    â”‚   â”œâ”€â”€ ã€Œæ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—
    â”‚   â”œâ”€â”€ ãƒªãƒ³ã‚¯ç”Ÿæˆ (æœ‰åŠ¹æœŸé™: 7æ—¥é–“)
    â”‚   â”œâ”€â”€ LINE/ãƒ¡ãƒ¼ãƒ«ç­‰ã§ãƒªãƒ³ã‚¯å…±æœ‰
    â”‚   â”œâ”€â”€ [å‚åŠ è€…] ãƒªãƒ³ã‚¯ã‚¿ãƒƒãƒ— â†’ ã‚¢ãƒ—ãƒªèµ·å‹•/ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«èª˜å°
    â”‚   â””â”€â”€ å‚åŠ ç¢ºèª â†’ å‚åŠ å®Œäº†
    â”‚
    â””â”€â”€ æ‹›å¾…ã‚³ãƒ¼ãƒ‰æ–¹å¼
        â”œâ”€â”€ 6æ¡è‹±æ•°å­—ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
        â”œâ”€â”€ [å‚åŠ è€…] ã€Œã‚³ãƒ¼ãƒ‰ã§å‚åŠ ã€ç”»é¢ã§ã‚³ãƒ¼ãƒ‰å…¥åŠ›
        â””â”€â”€ ç…§åˆæˆåŠŸ â†’ å‚åŠ å®Œäº†
```

- QRã‚³ãƒ¼ãƒ‰/æ‹›å¾…ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™: 7æ—¥é–“
- æ‹›å¾…ã‚³ãƒ¼ãƒ‰: ã‚°ãƒ«ãƒ¼ãƒ—å›ºå®šï¼ˆç®¡ç†è€…ãŒãƒªã‚»ãƒƒãƒˆå¯èƒ½ï¼‰
- å‚åŠ æ™‚ã«ç®¡ç†è€…ã¸é€šçŸ¥: ã€Œâ—‹â—‹ã•ã‚“ãŒãƒ•ã‚¡ãƒŸãƒªãƒ¼ã«å‚åŠ ã—ã¾ã—ãŸã€

#### 3.3.2 æ¨©é™ãƒ¢ãƒ‡ãƒ«

| æ¨©é™ | ç®¡ç†è€… (owner) | è¦ªä¸–ä»£ (parent) | ã‚·ãƒ‹ã‚¢ (senior) | å­ä¾› (child) |
|------|---------------|----------------|----------------|-------------|
| ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾… | o | o | x | x |
| ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤ | o | x | x | x |
| ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šå¤‰æ›´ | o | x | x | x |
| å…¨ãƒ¡ãƒ³ãƒãƒ¼ã‚¹ã‚³ã‚¢é–²è¦§ | o | o | è‡ªåˆ†ã®ã¿ | è‡ªåˆ†ã®ã¿ |
| ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡ | o | o | x | x |
| æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ | o | o (å®¶æ—åˆ†) | è‡ªåˆ†ã®ã¿ | x |
| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ | o | o | o | o |
| é€šçŸ¥è¨­å®šå¤‰æ›´ | o | è‡ªåˆ†ã®ã¿ | è‡ªåˆ†ã®ã¿ | x (ä¿è­·è€…è¨­å®š) |

- `role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ `owner` / `member` ã®2å€¤ã ãŒã€`ageGroup` ã¨çµ„ã¿åˆã‚ã›ã¦å®Ÿè³ªçš„ãªæ¨©é™ã‚’æ±ºå®š
- ç®¡ç†è€…ã®ç§»è­²: ç®¡ç†è€…ãŒåˆ¥ã®ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ä»¥ä¸Šï¼‰ã‚’æ–°ç®¡ç†è€…ã«æŒ‡å®šå¯èƒ½

#### 3.3.3 ãƒ‡ãƒ¼ã‚¿å…±æœ‰ç¯„å›²

| å…±æœ‰è¨­å®š | å…±æœ‰ã•ã‚Œã‚‹æƒ…å ± | å¯¾è±¡ |
|---------|-------------|------|
| `full` (å…¨å…¬é–‹) | ã‚¹ã‚³ã‚¢è©³ç´°ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã€ã‚«ãƒ†ã‚´ãƒªåˆ¥ã€ãƒ†ã‚¹ãƒˆå±¥æ­´ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
| `score_only` (ã‚¹ã‚³ã‚¢ã®ã¿) | ç·åˆã‚¹ã‚³ã‚¢ã€ãƒˆãƒ¬ãƒ³ãƒ‰çŸ¢å°ã®ã¿ | è©³ç´°éè¡¨ç¤º |
| `hidden` (éå…¬é–‹) | ã€Œãƒ†ã‚¹ãƒˆå®Ÿæ–½æ¸ˆã¿/æœªå®Ÿæ–½ã€ã®ã¿ | ã‚¹ã‚³ã‚¢éè¡¨ç¤º |

### 3.4 ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

#### 3.4.1 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¨®åˆ¥

| ç¨®åˆ¥ | åˆ¶é™ | ä¿å­˜æœŸé–“ | è£œè¶³ |
|------|------|---------|------|
| ã‚¹ã‚¿ãƒ³ãƒ— | ã‚«ãƒ†ã‚´ãƒª4ç¨® x å„8-12ç¨® = ç´„40ç¨® | ç„¡åˆ¶é™ | ãƒã‚¹ã‚³ãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä»˜ã |
| ãƒ†ã‚­ã‚¹ãƒˆ | ãªã—ï¼ˆMVPå¯¾è±¡å¤–ï¼‰ | - | å°†æ¥å®Ÿè£… |
| ãƒœã‚¤ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | æœ€å¤§30ç§’ã€500KB | 30æ—¥é–“ | 0.8xå†ç”Ÿå¯¾å¿œ |
| è‡ªå‹•é€šçŸ¥ | 1æ—¥5é€š/äººã¾ã§ | 90æ—¥é–“ | ãƒ†ã‚¹ãƒˆå®Œäº†ãƒ»æ–°è¨˜éŒ²ç­‰ |

#### 3.4.2 é€šçŸ¥ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶

| ãƒˆãƒªã‚¬ãƒ¼ | é€šçŸ¥å†…å®¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ | å„ªå…ˆåº¦ | ãƒãƒ£ãƒãƒ« |
|---------|-------------------|--------|---------|
| ãƒ†ã‚¹ãƒˆå®Œäº† | ã€Œ{name}ã•ã‚“ãŒãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å®Œäº†ã—ã¾ã—ãŸï¼ã‚¹ã‚³ã‚¢: {score}ç‚¹ã€ | ä¸­ | ã‚¢ãƒ—ãƒªå†… + ãƒ—ãƒƒã‚·ãƒ¥(è¨­å®šä¾å­˜) |
| æ–°è¨˜éŒ²é”æˆ | ã€Œ{name}ã•ã‚“ãŒ{category}ã§æ–°è¨˜éŒ²ã‚’é”æˆï¼{score}ç‚¹ã€ | é«˜ | ã‚¢ãƒ—ãƒªå†… + ãƒ—ãƒƒã‚·ãƒ¥ |
| é€£ç¶šè¨˜éŒ²æ›´æ–° | ã€Œ{name}ã•ã‚“ãŒ{days}æ—¥é€£ç¶šé”æˆï¼ã€ | é«˜ | ã‚¢ãƒ—ãƒªå†… + ãƒ—ãƒƒã‚·ãƒ¥ |
| ãƒãƒƒã‚¸ç²å¾— | ã€Œ{name}ã•ã‚“ãŒã€{badge}ã€ãƒãƒƒã‚¸ã‚’ç²å¾—ï¼ã€ | é«˜ | ã‚¢ãƒ—ãƒªå†… + ãƒ—ãƒƒã‚·ãƒ¥ |
| ãƒ†ã‚¹ãƒˆæœªå®Ÿæ–½(å®¶æ—å‘ã‘) | ã€Œ{name}ã•ã‚“ãŒä»Šæ—¥ã¾ã ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€ | ä½ | ã‚¢ãƒ—ãƒªå†… |
| é•·æœŸæœªã‚¢ã‚¯ãƒ†ã‚£ãƒ– | ã€Œ{name}ã•ã‚“ãŒ{days}æ—¥é–“ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ã¾ã›ã‚“ã€ | é«˜ | ãƒ—ãƒƒã‚·ãƒ¥ + ãƒ¡ãƒ¼ãƒ«(è¨­å®šä¾å­˜) |
| ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¢ãƒ©ãƒ¼ãƒˆ | ã€Œ{name}ã•ã‚“ã®{category}ã‚¹ã‚³ã‚¢ã«å¤‰åŒ–ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€ | æœ€é«˜ | ãƒ—ãƒƒã‚·ãƒ¥ + ã‚¢ãƒ—ãƒªå†… |
| ã‚¹ã‚¿ãƒ³ãƒ—å—ä¿¡ | ã€Œ{name}ã•ã‚“ã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—ãŒå±Šãã¾ã—ãŸã€ | ä½ | ã‚¢ãƒ—ãƒªå†… |
| ãƒœã‚¤ã‚¹å—ä¿¡ | ã€Œ{name}ã•ã‚“ã‹ã‚‰ãƒœã‚¤ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã—ãŸã€ | ä¸­ | ã‚¢ãƒ—ãƒªå†… + ãƒ—ãƒƒã‚·ãƒ¥ |

#### 3.4.3 ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è¨­è¨ˆ

```typescript
interface PushNotificationPayload {
  title: string;
  body: string;
  icon: string;           // ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ or ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
  badge: number;          // æœªèª­æ•°
  tag: string;            // é€šçŸ¥ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ç”¨ã‚¿ã‚°
  data: {
    type: NotificationType;
    targetUrl: string;    // ã‚¿ãƒƒãƒ—æ™‚ã®é·ç§»å…ˆ
    familyId?: string;
    userId?: string;
  };
  actions?: Array<{       // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½é€šçŸ¥
    action: string;
    title: string;
  }>;
}

// é€šçŸ¥ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
// åŒä¸€ã‚¿ã‚°ã®é€šçŸ¥ã¯ä¸Šæ›¸ãã•ã‚Œã€é€šçŸ¥ãŒæº¢ã‚Œã‚‹ã“ã¨ã‚’é˜²ã
const NOTIFICATION_TAGS = {
  test_completed: 'family-{familyId}-test',
  daily_reminder: 'reminder-daily',
  trend_alert: 'alert-{userId}',
  message: 'message-{familyId}',
};
```

### 3.5 ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

#### 3.5.1 ãƒãƒƒã‚¸ä¸€è¦§ã¨ç²å¾—æ¡ä»¶

**ç¶™ç¶šç³»ãƒãƒƒã‚¸**

| ãƒãƒƒã‚¸å | ãƒ†ã‚£ã‚¢ | ç²å¾—æ¡ä»¶ | ã‚¢ã‚¤ã‚³ãƒ³ |
|---------|--------|---------|---------|
| ã¯ã˜ã‚ã®ä¸€æ­© | ãƒ–ãƒ­ãƒ³ã‚º | åˆã‚ã¦ãƒ†ã‚¹ãƒˆã‚’å®Œäº† | è¶³è·¡ |
| 1é€±é–“ãƒã‚¹ã‚¿ãƒ¼ | ãƒ–ãƒ­ãƒ³ã‚º | 7æ—¥é€£ç¶šãƒ†ã‚¹ãƒˆå®Œäº† | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼(éŠ…) |
| 1ãƒ¶æœˆãƒã‚¹ã‚¿ãƒ¼ | ã‚·ãƒ«ãƒãƒ¼ | 30æ—¥é€£ç¶šãƒ†ã‚¹ãƒˆå®Œäº† | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼(éŠ€) |
| 100æ—¥ãƒã‚¹ã‚¿ãƒ¼ | ã‚´ãƒ¼ãƒ«ãƒ‰ | 100æ—¥é€£ç¶šãƒ†ã‚¹ãƒˆå®Œäº† | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼(é‡‘) |
| 365æ—¥ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ | ã‚´ãƒ¼ãƒ«ãƒ‰ | 365æ—¥é€£ç¶šãƒ†ã‚¹ãƒˆå®Œäº† | ãƒˆãƒ­ãƒ•ã‚£ãƒ¼(é‡‘) |

**ã‚¹ã‚³ã‚¢ç³»ãƒãƒƒã‚¸**

| ãƒãƒƒã‚¸å | ãƒ†ã‚£ã‚¢ | ç²å¾—æ¡ä»¶ | ã‚¢ã‚¤ã‚³ãƒ³ |
|---------|--------|---------|---------|
| 90ç‚¹ã‚¯ãƒ©ãƒ– | ãƒ–ãƒ­ãƒ³ã‚º | åˆã‚ã¦ç·åˆ90ç‚¹ä»¥ä¸Š | æ˜Ÿ(éŠ…) |
| ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒãƒ©ãƒ³ã‚¹ | ã‚·ãƒ«ãƒãƒ¼ | 5ã‚«ãƒ†ã‚´ãƒªå…¨ã¦80ç‚¹ä»¥ä¸Š | äº”è§’å½¢(éŠ€) |
| è¨˜éŒ²æ›´æ–°ç‹ | ã‚·ãƒ«ãƒãƒ¼ | æœ€é«˜ã‚¹ã‚³ã‚¢æ›´æ–°10å› | ä¸ŠçŸ¢å°(éŠ€) |
| å…¨ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿ãƒ¼ | ã‚´ãƒ¼ãƒ«ãƒ‰ | 5ã‚«ãƒ†ã‚´ãƒªå…¨ã¦90ç‚¹ä»¥ä¸Š | ç‹å† (é‡‘) |

**ãƒ•ã‚¡ãƒŸãƒªãƒ¼ç³»ãƒãƒƒã‚¸**

| ãƒãƒƒã‚¸å | ãƒ†ã‚£ã‚¢ | ç²å¾—æ¡ä»¶ | ã‚¢ã‚¤ã‚³ãƒ³ |
|---------|--------|---------|---------|
| ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ‡ãƒ“ãƒ¥ãƒ¼ | ãƒ–ãƒ­ãƒ³ã‚º | ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã«å‚åŠ  | å®¶(éŠ…) |
| å…¨å“¡é›†åˆ | ã‚·ãƒ«ãƒãƒ¼ | å®¶æ—å…¨å“¡ãŒåŒæ—¥ã«ãƒ†ã‚¹ãƒˆå®Œäº† | å®¶æ—(éŠ€) |
| åŠ±ã¾ã—ãƒã‚¹ã‚¿ãƒ¼ | ã‚·ãƒ«ãƒãƒ¼ | å®¶æ—ã«10å›åŠ±ã¾ã—ã‚’é€ã£ãŸ | ãƒãƒ¼ãƒˆ(éŠ€) |
| ãƒãƒ¼ãƒ åˆå‹åˆ© | ã‚´ãƒ¼ãƒ«ãƒ‰ | ä¸–ä»£å¯¾æŠ—æˆ¦ã§åˆå‹åˆ© | æ——(é‡‘) |

**å­£ç¯€ç³»ãƒãƒƒã‚¸**

| ãƒãƒƒã‚¸å | ãƒ†ã‚£ã‚¢ | ç²å¾—æ¡ä»¶ | æœŸé–“ |
|---------|--------|---------|------|
| æ›¸ãåˆã‚ãƒã‚¹ã‚¿ãƒ¼ | ã‚·ãƒ«ãƒãƒ¼ | ãŠæ­£æœˆãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº† | 1/1-1/7 |
| ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ | ãƒ–ãƒ­ãƒ³ã‚º | ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ  | 2/10-2/14 |
| ã²ãªç¥­ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ | ãƒ–ãƒ­ãƒ³ã‚º | ã²ãªç¥­ã‚Šã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ  | 3/1-3/3 |
| ã“ã©ã‚‚ã®æ—¥ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ | ã‚·ãƒ«ãƒãƒ¼ | ã“ã©ã‚‚ã®æ—¥ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº† | 5/1-5/5 |
| ä¸ƒå¤•ã®é¡˜ã„ | ãƒ–ãƒ­ãƒ³ã‚º | ä¸ƒå¤•ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ  | 7/1-7/7 |
| å¤ç¥­ã‚Šãƒã‚¹ã‚¿ãƒ¼ | ã‚·ãƒ«ãƒãƒ¼ | å¤ç¥­ã‚Šã‚¤ãƒ™ãƒ³ãƒˆå®Œäº† | 8/1-8/15 |
| æ•¬è€ã®æ—¥ã‚¹ãƒšã‚·ãƒ£ãƒ« | ã‚´ãƒ¼ãƒ«ãƒ‰ | æ•¬è€ã®æ—¥ã‚¤ãƒ™ãƒ³ãƒˆå®Œäº† | 9æœˆç¬¬3æœˆæ›œå‰å¾Œ |
| ã‚¯ãƒªã‚¹ãƒã‚¹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ | ã‚·ãƒ«ãƒãƒ¼ | ã‚¯ãƒªã‚¹ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆå®Œäº† | 12/20-12/25 |

**ç‰¹åˆ¥ç³»ãƒãƒƒã‚¸**

| ãƒãƒƒã‚¸å | ãƒ†ã‚£ã‚¢ | ç²å¾—æ¡ä»¶ |
|---------|--------|---------|
| åˆã‚ã¦ã®ãƒ†ã‚¹ãƒˆ | ãƒ–ãƒ­ãƒ³ã‚º | ãƒ†ã‚¹ãƒˆ1å›å®Œäº† |
| å…¨ã‚«ãƒ†ã‚´ãƒªä½“é¨“ | ãƒ–ãƒ­ãƒ³ã‚º | 5ã‚«ãƒ†ã‚´ãƒªå…¨ã¦ã‚’1å›ä»¥ä¸Šãƒ—ãƒ¬ã‚¤ |
| ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼åˆå®Œèµ° | ãƒ–ãƒ­ãƒ³ã‚º | ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸åˆå®Œäº† |
| ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ— | ã‚·ãƒ«ãƒãƒ¼ | ä»»æ„ã®ã‚«ãƒ†ã‚´ãƒªã§é›£æ˜“åº¦ãŒä¸Šæ˜‡ |
| ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ | ã‚´ãƒ¼ãƒ«ãƒ‰ | ãƒãƒƒã‚¸ã‚’20å€‹ä»¥ä¸Šç²å¾— |

#### 3.5.2 é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³ã®å ±é…¬ãƒ†ãƒ¼ãƒ–ãƒ«

| æ—¥æ•° | ã‚³ã‚¤ãƒ³ | ãƒœãƒ¼ãƒŠã‚¹ |
|------|--------|---------|
| 1æ—¥ç›® | 10 | - |
| 2æ—¥ç›® | 15 | - |
| 3æ—¥ç›® | 20 | - |
| 4æ—¥ç›® | 25 | - |
| 5æ—¥ç›® | 30 | - |
| 6æ—¥ç›® | 35 | - |
| 7æ—¥ç›® | 50 | ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ã‚¿ãƒ³ãƒ—1æš |
| 14æ—¥ç›® | 75 | é™å®šç€ã›æ›¿ãˆã‚¢ã‚¤ãƒ†ãƒ (å¸½å­) |
| 30æ—¥ç›® | 100 | é™å®šç€ã›æ›¿ãˆã‚¢ã‚¤ãƒ†ãƒ (èƒŒæ™¯) + ã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒƒã‚¸ |
| 60æ—¥ç›® | 150 | é™å®šã‚¨ãƒ•ã‚§ã‚¯ãƒˆ |
| 100æ—¥ç›® | 200 | é™å®šãƒ•ãƒ«ã‚»ãƒƒãƒˆ |
| 365æ—¥ç›® | 500 | ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ç§°å· + å…¨ã‚¢ã‚¤ãƒ†ãƒ è§£æ”¾ |

- 8æ—¥ç›®ä»¥é™ã€14æ—¥ç›®ã¾ã§ã®æ—¥ã¯1æ—¥ã‚ãŸã‚Š10ã‚³ã‚¤ãƒ³
- 15æ—¥ç›®ä»¥é™ã€30æ—¥ç›®ã¾ã§ã®æ—¥ã¯1æ—¥ã‚ãŸã‚Š15ã‚³ã‚¤ãƒ³
- 31æ—¥ç›®ä»¥é™ã¯1æ—¥ã‚ãŸã‚Š20ã‚³ã‚¤ãƒ³
- é€£ç¶šè¨˜éŒ²ãŒé€”åˆ‡ã‚ŒãŸå ´åˆã¯1æ—¥ç›®ã‹ã‚‰ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
- éå»ã®æœ€é•·é€£ç¶šè¨˜éŒ²ã¯ä¿æŒã•ã‚Œã‚‹

#### 3.5.3 ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‚²æˆã®ä»•çµ„ã¿

**ã®ã†ãŸã‚“ï¼ˆãƒ•ã‚¯ãƒ­ã‚¦ã®èµ¤ã¡ã‚ƒã‚“ï¼‰ã®æˆé•·æ®µéš:**

| æ®µéš | æ¡ä»¶ | è¦‹ãŸç›®ã®å¤‰åŒ– |
|------|------|------------|
| ãŸã¾ã” | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆç›´å¾Œ | åµã®ä¸­ã§ã‚†ã‚‰ã‚†ã‚‰ |
| ãƒ’ãƒŠ | åˆå›ãƒ†ã‚¹ãƒˆå®Œäº† | å°ã•ãªãƒ•ã‚¯ãƒ­ã‚¦ã€å¤§ããªç›® |
| å­ãƒ•ã‚¯ãƒ­ã‚¦ | 7æ—¥é€£ç¶šãƒ†ã‚¹ãƒˆå®Œäº† | å°‘ã—å¤§ãããªã‚Šã€ç¾½ãŒç”Ÿãˆã‚‹ |
| è‹¥ãƒ•ã‚¯ãƒ­ã‚¦ | 30æ—¥é€£ç¶šãƒ†ã‚¹ãƒˆå®Œäº† | ç¾½ãŒç«‹æ´¾ã«ã€è¡¨æƒ…è±Šã‹ |
| è³¢è€…ãƒ•ã‚¯ãƒ­ã‚¦ | 100æ—¥é€£ç¶šãƒ†ã‚¹ãƒˆå®Œäº† | åšå£«å¸½ã€çŸ¥æµã®å…‰ |

**è¡¨æƒ…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ8ç¨®ï¼‰:**

| çŠ¶æ…‹ | ãƒˆãƒªã‚¬ãƒ¼ | ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ |
|------|---------|-------------|
| é€šå¸¸ | å¾…æ©Ÿä¸­ | ã‚†ã‚‰ã‚†ã‚‰æºã‚Œã‚‹ (idle loop) |
| å–œã³ | ã‚¹ã‚³ã‚¢70ç‚¹ä»¥ä¸Š | ã‚¸ãƒ£ãƒ³ãƒ— + æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆ |
| å¤§å–œã³ | æ–°è¨˜éŒ²é”æˆ | å›è»¢ã‚¸ãƒ£ãƒ³ãƒ— + ç´™å¹é›ª |
| å¿œæ´ | ãƒ†ã‚¹ãƒˆä¸­ | æ‰‹ã‚’æŒ¯ã‚‹ + ã€ŒãŒã‚“ã°ã‚Œã€å¹ãå‡ºã— |
| çœ ã„ | æ·±å¤œã‚¢ã‚¯ã‚»ã‚¹ (22:00-5:00) | ç›®ã‚’ã“ã™ã‚Š + ã‚ãã³ |
| ã³ã£ãã‚Š | äºˆæƒ³å¤–ã®é«˜ã‚¹ã‚³ã‚¢ | ç›®ã‚’è¦‹é–‹ã + ã€Œ!ã€ãƒãƒ¼ã‚¯ |
| ãŒã‚“ã°ã‚Œ | ã‚¹ã‚³ã‚¢50ç‚¹ä»¥ä¸‹ | é ­ã‚’ãªã§ã‚‹ + ã€Œå¤§ä¸ˆå¤«ã€å¹ãå‡ºã— |
| ãŠç¥ã„ | ãƒãƒƒã‚¸ç²å¾— | ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒãƒƒãƒˆ + ã‚¯ãƒ©ãƒƒã‚«ãƒ¼ |

#### 3.5.4 ä¸–ä»£å¯¾æŠ—æˆ¦ã®ãƒ«ãƒ¼ãƒ«

```
ãƒãƒ¼ãƒ æ§‹æˆ:
  ã‚·ãƒ‹ã‚¢ãƒãƒ¼ãƒ : ageGroup = 'senior' | 'senior_plus'
  è¦ªãƒãƒ¼ãƒ :     ageGroup = 'standard'
  ã‚­ãƒƒã‚ºãƒãƒ¼ãƒ : ageGroup = 'kids' | 'junior'

ãƒãƒ¼ãƒ ã‚¹ã‚³ã‚¢è¨ˆç®—:
  team_score = Î£(ãƒ¡ãƒ³ãƒãƒ¼ã‚¹ã‚³ã‚¢) / ãƒ¡ãƒ³ãƒãƒ¼æ•°

  // å°‘äººæ•°è£œæ­£ (1äººãƒãƒ¼ãƒ ã®ä¸åˆ©ã‚’è§£æ¶ˆ)
  if (ãƒ¡ãƒ³ãƒãƒ¼æ•° === 1) team_score *= 1.2
  if (ãƒ¡ãƒ³ãƒãƒ¼æ•° === 2) team_score *= 1.1

å¯¾æŠ—æˆ¦æœŸé–“: æ¯é€±æœˆæ›œ 00:00 ã€œ æ—¥æ›œ 23:59

å‹åˆ©æ¡ä»¶: é€±é–“ãƒãƒ¼ãƒ ã‚¹ã‚³ã‚¢ãŒæœ€ã‚‚é«˜ã„ãƒãƒ¼ãƒ 

å ±é…¬:
  1ä½ãƒãƒ¼ãƒ : å…¨ãƒ¡ãƒ³ãƒãƒ¼ã«30ã‚³ã‚¤ãƒ³ + ã€Œãƒãƒ¼ãƒ å‹åˆ©ã€ãƒãƒƒã‚¸(åˆå›ã®ã¿)
  2ä½ãƒãƒ¼ãƒ : å…¨ãƒ¡ãƒ³ãƒãƒ¼ã«15ã‚³ã‚¤ãƒ³
  3ä½ãƒãƒ¼ãƒ : å…¨ãƒ¡ãƒ³ãƒãƒ¼ã«10ã‚³ã‚¤ãƒ³ + ã€ŒãƒŠã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒˆã€ã‚¹ã‚¿ãƒ³ãƒ—

ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«:
  - 1ãƒãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒ0äººã®å ´åˆã€2ãƒãƒ¼ãƒ å¯¾æŠ—ã«å¤‰æ›´
  - å…¨ãƒãƒ¼ãƒ 1äººä»¥ä¸‹ã®å ´åˆã€ä¸–ä»£å¯¾æŠ—æˆ¦ã¯éè¡¨ç¤º
  - ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¨ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ä¸¡æ–¹ã®ã‚¹ã‚³ã‚¢ãŒé›†è¨ˆå¯¾è±¡
```

---

## 4. Zustand Storeè¨­è¨ˆ

### 4.1 userStore

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface UserState {
  // State
  user: User | null;
  isAuthenticated: boolean;
  isOnboardingCompleted: boolean;
  settings: UserSettings;
  authToken: string | null;
  refreshToken: string | null;

  // Actions
  setUser: (user: User) => void;
  updateSettings: (settings: Partial<UserSettings>) => void;
  setTokens: (auth: string, refresh: string) => void;
  clearAuth: () => void;
  completeOnboarding: () => void;

  // Computed (getters)
  getAgeGroup: () => AgeGroup | null;
  isSenior: () => boolean;
  isKids: () => boolean;
  getFontSize: () => number;
}

const useUserStore = create<UserState>()(
  persist(
    (set, get) => ({
      user: null,
      isAuthenticated: false,
      isOnboardingCompleted: false,
      settings: {
        fontSize: 'medium',
        highContrast: false,
        darkMode: false,
        simpleUiMode: false,
        voiceGuide: false,
        reminderTime: '09:00',
        reminderDays: [0, 1, 2, 3, 4, 5, 6],
        notificationEnabled: true,
        locale: 'ja',
      },
      authToken: null,
      refreshToken: null,

      setUser: (user) => set({ user, isAuthenticated: true }),
      updateSettings: (partial) =>
        set((state) => ({
          settings: { ...state.settings, ...partial },
        })),
      setTokens: (auth, refresh) =>
        set({ authToken: auth, refreshToken: refresh }),
      clearAuth: () =>
        set({
          user: null,
          isAuthenticated: false,
          authToken: null,
          refreshToken: null,
        }),
      completeOnboarding: () => set({ isOnboardingCompleted: true }),

      getAgeGroup: () => get().user?.ageGroup ?? null,
      isSenior: () => {
        const ag = get().user?.ageGroup;
        return ag === 'senior' || ag === 'senior_plus';
      },
      isKids: () => {
        const ag = get().user?.ageGroup;
        return ag === 'kids' || ag === 'junior';
      },
      getFontSize: () => {
        const map = { small: 14, medium: 18, large: 24, xlarge: 32 };
        return map[get().settings.fontSize];
      },
    }),
    {
      name: 'user-storage',
      partialize: (state) => ({
        user: state.user,
        isAuthenticated: state.isAuthenticated,
        isOnboardingCompleted: state.isOnboardingCompleted,
        settings: state.settings,
        refreshToken: state.refreshToken,
      }),
    }
  )
);
```

### 4.2 familyStore

```typescript
interface FamilyState {
  // State
  families: Family[];
  activeFamilyId: string | null;
  memberStatuses: Record<string, MemberDailyStatus>;
  rankings: FamilyRanking | null;
  teamBattle: TeamBattleData | null;
  lastPolledAt: number;

  // Actions
  setFamilies: (families: Family[]) => void;
  setActiveFamily: (familyId: string) => void;
  updateMemberStatus: (userId: string, status: MemberDailyStatus) => void;
  setRankings: (rankings: FamilyRanking) => void;
  setTeamBattle: (data: TeamBattleData) => void;
  refreshDashboard: () => Promise<void>;

  // Computed
  getActiveFamily: () => Family | null;
  getActiveFamilyMembers: () => FamilyMember[];
}

interface MemberDailyStatus {
  userId: string;
  displayName: string;
  avatarUrl: string | null;
  relationship: Relationship;
  todayTestCompleted: boolean;
  latestScore: number | null;
  trend: 'improving' | 'stable' | 'declining';
  condition: 'sunny' | 'partly_cloudy' | 'cloudy'; // ä»Šæ—¥ã®èª¿å­
  lastActiveAt: string;
}

interface FamilyRanking {
  daily: RankEntry[];
  weekly: RankEntry[];
  streak: RankEntry[];
  categoryChampions: Record<TestCategory, RankEntry>;
}

interface RankEntry {
  userId: string;
  displayName: string;
  avatarUrl: string | null;
  score: number;
  rank: number;
}

interface TeamBattleData {
  weekStart: string;
  weekEnd: string;
  teams: {
    senior: { members: string[]; averageScore: number };
    parent: { members: string[]; averageScore: number };
    kids: { members: string[]; averageScore: number };
  };
  currentLeader: 'senior' | 'parent' | 'kids';
}
```

### 4.3 gameStore

```typescript
interface GameState {
  // State
  currentChallenge: Challenge | null;
  currentQuestionIndex: number;
  answers: Answer[];
  timeRemaining: number;
  isTimerRunning: boolean;
  gamePhase: 'idle' | 'ready' | 'playing' | 'paused' | 'completed';
  difficultyProfile: DifficultyProfile | null;

  // Actions
  startChallenge: (challenge: Challenge) => void;
  submitAnswer: (answer: Answer) => void;
  nextQuestion: () => void;
  pauseGame: () => void;
  resumeGame: () => void;
  completeGame: () => void;
  resetGame: () => void;
  setTimeRemaining: (time: number) => void;
  updateDifficulty: (category: TestCategory, level: DifficultyLevel) => void;

  // Computed
  getCurrentQuestion: () => Question | null;
  getProgress: () => { current: number; total: number; percent: number };
  isLastQuestion: () => boolean;
}

interface Answer {
  questionId: string;
  category: TestCategory;
  userAnswer: unknown;         // ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã«å¿œã˜ãŸå›ç­”ãƒ‡ãƒ¼ã‚¿
  isCorrect: boolean;
  responseTime: number;        // ãƒŸãƒªç§’
  score: number;
  maxScore: number;
  submittedAt: string;
}
```

### 4.4 scoreStore

```typescript
interface ScoreState {
  // State
  scoreHistory: Score[];
  dailyScores: Record<string, number>;  // date -> totalScore
  categoryTrends: Record<TestCategory, TrendData>;
  radarData: CategoryScores | null;
  streakCount: number;
  bestStreak: number;
  calendar: Record<string, 'completed' | 'login_only' | 'missed'>;
  lastFetchedAt: number;

  // Actions
  addScore: (score: Score) => void;
  setScoreHistory: (scores: Score[]) => void;
  updateTrends: () => void;
  updateCalendar: (month: string) => void;
  fetchScores: (period: '1w' | '1m' | '3m' | '6m' | '1y') => Promise<void>;

  // Computed
  getLatestScore: () => Score | null;
  getTotalScore: () => number;
  getScoresForChart: (period: string) => ChartDataPoint[];
  getRadarChartData: () => RadarDataPoint[];
  getStreakInfo: () => { current: number; best: number };
}

interface ChartDataPoint {
  date: string;
  score: number;
  category?: TestCategory;
}

interface RadarDataPoint {
  category: string;
  label: string;
  score: number;
  previousScore: number;
}
```

### 4.5 messageStore

```typescript
interface MessageState {
  // State
  messages: Message[];
  unreadCount: number;
  stampCategories: StampCategory[];
  isRecording: boolean;

  // Actions
  setMessages: (messages: Message[]) => void;
  addMessage: (message: Message) => void;
  sendStamp: (familyId: string, recipientId: string | null, stampId: string) => Promise<void>;
  sendVoice: (familyId: string, recipientId: string | null, audioBlob: Blob) => Promise<void>;
  markAsRead: (messageId: string) => void;
  markAllAsRead: (familyId: string) => void;
  setRecording: (isRecording: boolean) => void;
  fetchMessages: (familyId: string) => Promise<void>;

  // Computed
  getUnreadByFamily: (familyId: string) => number;
  getRecentMessages: (familyId: string, limit: number) => Message[];
}

interface StampCategory {
  id: string;
  name: string;               // åŠ±ã¾ã—ã€ãŠç¥ã„ã€ã‚ã„ã•ã¤ã€æ„Ÿæƒ…
  stamps: StampItem[];
}

interface StampItem {
  id: string;
  emoji: string;
  label: string;              // ã€ŒãŒã‚“ã°ã£ã¦ï¼ã€ã€Œã™ã”ã„ï¼ã€ç­‰
  imageUrl: string;           // ãƒã‚¹ã‚³ãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä»˜ãç”»åƒ
}
```

### 4.6 characterStore

```typescript
interface CharacterState {
  // State
  stage: 'egg' | 'chick' | 'young' | 'adolescent' | 'wise';
  coins: number;
  unlockedItems: string[];
  equippedItems: {
    hat: string | null;
    accessory: string | null;
    background: string | null;
    effect: string | null;
  };
  currentMood: CharacterMood;
  availableItems: CharacterItem[];

  // Actions
  setStage: (stage: CharacterState['stage']) => void;
  addCoins: (amount: number) => void;
  spendCoins: (amount: number) => boolean; // æ®‹é«˜ä¸è¶³æ™‚ false
  unlockItem: (itemId: string) => Promise<boolean>;
  equipItem: (type: string, itemId: string | null) => void;
  setMood: (mood: CharacterMood) => void;
  checkEvolution: (streakDays: number) => void;
  fetchItems: () => Promise<void>;

  // Computed
  canAfford: (cost: number) => boolean;
  getEquippedSet: () => EquippedSet;
}

type CharacterMood =
  | 'normal'     // é€šå¸¸
  | 'happy'      // å–œã³
  | 'ecstatic'   // å¤§å–œã³
  | 'cheering'   // å¿œæ´
  | 'sleepy'     // çœ ã„
  | 'surprised'  // ã³ã£ãã‚Š
  | 'encouraging'// ãŒã‚“ã°ã‚Œ
  | 'celebrating'; // ãŠç¥ã„
```

---

## 5. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æˆ¦ç•¥

### 5.1 Service Workerè¨­è¨ˆ

```
Service Worker ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«:
  install â†’ activate â†’ fetch/sync/push

ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache-First (é™çš„ã‚¢ã‚»ãƒƒãƒˆ)                     â”‚
â”‚ â”œâ”€â”€ /_next/static/**  (JS/CSSãƒãƒ³ãƒ‰ãƒ«)        â”‚
â”‚ â”œâ”€â”€ /images/**        (ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ)        â”‚
â”‚ â”œâ”€â”€ /sounds/**        (åŠ¹æœéŸ³)                 â”‚
â”‚ â”œâ”€â”€ /fonts/**         (Webãƒ•ã‚©ãƒ³ãƒˆ)            â”‚
â”‚ â””â”€â”€ /stamps/**        (ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒ)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Network-First (å‹•çš„ãƒ‡ãƒ¼ã‚¿)                     â”‚
â”‚ â”œâ”€â”€ /api/challenges/daily   (ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸) â”‚
â”‚ â”œâ”€â”€ /api/scores/me          (è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢)      â”‚
â”‚ â””â”€â”€ /api/families/*         (ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stale-While-Revalidate (æº–å‹•çš„)                â”‚
â”‚ â”œâ”€â”€ /api/gamification/badges (ãƒãƒƒã‚¸ä¸€è¦§)       â”‚
â”‚ â”œâ”€â”€ /api/gamification/character/items (ã‚¢ã‚¤ãƒ†ãƒ )â”‚
â”‚ â””â”€â”€ /api/scores/average/*   (å¹´é½¢åˆ¥å¹³å‡)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Network-Only (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¿…é ˆ)                  â”‚
â”‚ â”œâ”€â”€ /api/auth/**            (èªè¨¼)             â”‚
â”‚ â”œâ”€â”€ /api/messages/**        (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡)   â”‚
â”‚ â””â”€â”€ /api/notifications/**   (é€šçŸ¥)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãƒ—ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡:**

- ç¿Œæ—¥ã®ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆå‰æ—¥23:00ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å–å¾—ï¼‰
- ä»Šé€±ã®ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆæœˆæ›œæœã«å–å¾—ï¼‰
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒå…¨ã‚»ãƒƒãƒˆ
- ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒå…¨ã‚»ãƒƒãƒˆ
- åŠ¹æœéŸ³ãƒ•ã‚¡ã‚¤ãƒ«

### 5.2 IndexedDB ã‚¹ã‚­ãƒ¼ãƒ

```typescript
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å: 'noukatsu-family-db'
// ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1

interface DBSchema {
  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢å®šç¾©
  stores: {
    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    challenges: {
      key: string;           // challengeId
      value: Challenge;
      indexes: {
        byDate: string;      // date
        byType: string;      // 'daily' | 'weekly'
        byStatus: string;    // status
      };
    };

    // ã‚¹ã‚³ã‚¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    scores: {
      key: string;           // scoreId
      value: Score;
      indexes: {
        byDate: string;      // date
        byUserId: string;    // userId
        byCategory: string;  // category
      };
    };

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    messages: {
      key: string;           // messageId
      value: Message;
      indexes: {
        byFamilyId: string;
        byCreatedAt: string;
        byIsRead: number;    // 0 | 1
      };
    };

    // åŒæœŸã‚­ãƒ¥ãƒ¼
    syncQueue: {
      key: number;           // auto-increment
      value: SyncQueueItem;
      indexes: {
        byStatus: string;    // 'pending' | 'in_progress' | 'failed'
        byCreatedAt: string;
        byRetryCount: number;
      };
    };

    // å›ç­”ãƒ‡ãƒ¼ã‚¿ (ãƒ†ã‚¹ãƒˆä¸­ã®ä¸€æ™‚ä¿å­˜)
    pendingAnswers: {
      key: string;           // challengeId
      value: {
        challengeId: string;
        answers: Answer[];
        savedAt: string;
      };
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥
    userCache: {
      key: string;           // 'profile' | 'settings' | 'difficulty'
      value: unknown;
    };
  };
}
```

### 5.3 åŒæœŸã‚­ãƒ¥ãƒ¼è¨­è¨ˆ

```typescript
interface SyncQueueItem {
  id: number;                // auto-increment
  type: SyncItemType;
  method: 'POST' | 'PUT' | 'DELETE';
  endpoint: string;
  payload: unknown;
  status: 'pending' | 'in_progress' | 'failed' | 'completed';
  retryCount: number;
  maxRetries: number;        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3
  createdAt: string;
  lastAttemptAt: string | null;
  error: string | null;
}

type SyncItemType =
  | 'challenge_answer'       // ãƒ†ã‚¹ãƒˆå›ç­”é€ä¿¡
  | 'challenge_complete'     // ãƒ†ã‚¹ãƒˆå®Œäº†
  | 'score_submit'           // ã‚¹ã‚³ã‚¢é€ä¿¡
  | 'stamp_send'             // ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡
  | 'voice_send'             // ãƒœã‚¤ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  | 'settings_update'        // è¨­å®šæ›´æ–°
  | 'profile_update';        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
```

**åŒæœŸãƒ•ãƒ­ãƒ¼:**

```
[ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚]
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    â†’ Zustand Storeæ›´æ–° (å³åº§ã«UIåæ˜ )
    â†’ IndexedDBä¿å­˜ (ãƒ­ãƒ¼ã‚«ãƒ«æ°¸ç¶šåŒ–)
    â†’ SyncQueueè¿½åŠ  (status: 'pending')

[ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚]
  Service Worker: 'sync' ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥
    â†’ SyncQueueã‹ã‚‰ pending ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾— (FIFO)
    â†’ é †æ¬¡APIé€ä¿¡
      â†’ æˆåŠŸ: status = 'completed', IndexedDBæ›´æ–°
      â†’ å¤±æ•—: retryCount++, status = 'failed'
        â†’ retryCount < maxRetries: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å†è©¦è¡Œ
        â†’ retryCount >= maxRetries: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥

[å®šæœŸåŒæœŸ]
  5åˆ†é–“éš”ã§SyncQueueãƒã‚§ãƒƒã‚¯
  pending/failedã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°åŒæœŸè©¦è¡Œ
```

### 5.4 ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±º

```typescript
type ConflictResolution = 'server_wins' | 'client_wins' | 'merge' | 'ask_user';

const CONFLICT_STRATEGIES: Record<SyncItemType, ConflictResolution> = {
  challenge_answer: 'client_wins',    // ãƒ­ãƒ¼ã‚«ãƒ«å›ç­”ã‚’å„ªå…ˆ
  challenge_complete: 'client_wins',  // ãƒ­ãƒ¼ã‚«ãƒ«å®Œäº†ã‚’å„ªå…ˆ
  score_submit: 'server_wins',        // ã‚µãƒ¼ãƒãƒ¼è¨ˆç®—ã‚’æ­£ã¨ã™ã‚‹
  stamp_send: 'merge',                // ä¸¡æ–¹ä¿æŒ
  voice_send: 'merge',                // ä¸¡æ–¹ä¿æŒ
  settings_update: 'client_wins',     // æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’å„ªå…ˆ
  profile_update: 'client_wins',      // æœ€æ–°ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å„ªå…ˆ
};
```

**ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç™ºç”Ÿæ™‚ã®ãƒ•ãƒ­ãƒ¼:**

```
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒ‡ãƒ¼ã‚¿é€ä¿¡
2. ã‚µãƒ¼ãƒãƒ¼ãŒ409 Conflictã‚’è¿”å´
3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã‚µãƒ¼ãƒãƒ¼å´ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€
4. CONFLICT_STRATEGIESã«åŸºã¥ãè§£æ±º:
   - server_wins: ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šæ›¸ã
   - client_wins: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã§å†é€ä¿¡ (If-Matchç„¡è¦–)
   - merge: ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ (ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§æ•´åˆ—)
   - ask_user: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã•ã›ã‚‹
5. è§£æ±ºå¾Œã€IndexedDBãƒ»Zustand Storeã‚’æ›´æ–°
```

---

## 6. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

### 6.1 è¨˜æ†¶åŠ›ãƒ†ã‚¹ãƒˆ: å˜èªè¨˜æ†¶ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰é›£æ˜“åº¦ã€7å˜èªï¼‰

| å•é¡Œ# | è¡¨ç¤ºå˜èªãƒªã‚¹ãƒˆ | æ­£è§£ |
|-------|-------------|------|
| 1 | ã‚Šã‚“ã”ã€é›»è»Šã€å¤ªé™½ã€ãƒ”ã‚¢ãƒã€é‡‘é­šã€æ™‚è¨ˆã€å‚˜ | å…¨å˜èªã‚’é †åºé€šã‚Šã«å›ç­” |
| 2 | æ¡œã€æ‰‹ç´™ã€æœˆã€è‡ªè»¢è»Šã€çŒ«ã€ã‚«ãƒ¡ãƒ©ã€é¢¨èˆ¹ | å…¨å˜èªã‚’é †åºé€šã‚Šã«å›ç­” |
| 3 | å±±ã€éµã€æ˜Ÿã€å¸½å­ã€ã‚¤ãƒ«ã‚«ã€æœ¬ã€è™¹ | å…¨å˜èªã‚’é †åºé€šã‚Šã«å›ç­” |
| 4 | èŠ±ç«ã€é³¥ã€é¡ã€èˆ¹ã€é›²ã€éˆ´ã€æ©‹ | å…¨å˜èªã‚’é †åºé€šã‚Šã«å›ç­” |
| 5 | é›ªã€è²ã€æ——ã€æ¤…å­ã€è¶ã€çŸ³ã€çª“ | å…¨å˜èªã‚’é †åºé€šã‚Šã«å›ç­” |

### 6.2 æ³¨æ„åŠ›ãƒ†ã‚¹ãƒˆ: ã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ

| å•é¡Œ# | è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ | è¡¨ç¤ºè‰² | æ­£è§£ |
|-------|-----------|--------|------|
| 1 | ã‚ã‹ | é’ | é’ |
| 2 | ã¿ã©ã‚Š | èµ¤ | èµ¤ |
| 3 | ãã„ã‚ | ç·‘ | ç·‘ |
| 4 | ã‚ãŠ | é»„ | é»„ |
| 5 | ã‚ã‹ | èµ¤ | èµ¤ |

### 6.3 è¨€èªåŠ›ãƒ†ã‚¹ãƒˆ: ã‚¢ãƒŠã‚°ãƒ©ãƒ ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰é›£æ˜“åº¦ï¼‰

| å•é¡Œ# | ãƒãƒ©ãƒãƒ©æ–‡å­— | æ­£è§£ | ãƒ’ãƒ³ãƒˆ |
|-------|-----------|------|--------|
| 1 | ã‚‰ ã• ã | ã•ãã‚‰ | æ˜¥ã®èŠ± |
| 2 | ã‚Š ã‚“ ã” ã‹ ã¿ ãª | ã‹ã¿ãªã‚Šã”ã‚ â†’ ã‹ã¿ãªã‚Š | å¤©æ°— (5æ–‡å­—ã‚’ä½¿ç”¨) |
| 3 | ã† ã¡ ã‚… ã† ã› ã‚“ | ã†ã¡ã‚…ã†ã›ã‚“ | å®‡å®™ã‚’é£›ã¶ |
| 4 | ã¶ ã© ã† ãˆ ã‚“ | ã¶ã©ã†ãˆã‚“ | æœç‰©ã‚’è‚²ã¦ã‚‹å ´æ‰€ |
| 5 | ã“ ãŸ ã¤ ã¿ ã‹ ã‚“ | ã“ãŸã¤ã¿ã‹ã‚“ â†’ ã“ãŸã¤ | å†¬ã®æš–æˆ¿ (3æ–‡å­—ã‚’ä½¿ç”¨) |

### 6.4 è¨ˆç®—åŠ›ãƒ†ã‚¹ãƒˆ: æš—ç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰é›£æ˜“åº¦ï¼‰

| å•é¡Œ# | å•é¡Œ | æ­£è§£ | åˆ¶é™æ™‚é–“ |
|-------|------|------|---------|
| 1 | 247 + 158 | 405 | 8ç§’ |
| 2 | 523 - 287 | 236 | 8ç§’ |
| 3 | 34 x 12 | 408 | 8ç§’ |
| 4 | 456 Ã· 8 | 57 | 8ç§’ |
| 5 | (15 + 27) x 3 | 126 | 8ç§’ |

### 6.5 ç©ºé–“èªè­˜ãƒ†ã‚¹ãƒˆ: æ•°åˆ—ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰é›£æ˜“åº¦ï¼‰

| å•é¡Œ# | æ•°åˆ— | æ­£è§£ | ãƒ‘ã‚¿ãƒ¼ãƒ³ |
|-------|------|------|---------|
| 1 | 3, 7, 11, 15, ? | 19 | ç­‰å·®æ•°åˆ— (d=4) |
| 2 | 2, 6, 18, 54, ? | 162 | ç­‰æ¯”æ•°åˆ— (r=3) |
| 3 | 1, 1, 2, 3, 5, 8, ? | 13 | ãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ— |
| 4 | 100, 95, 85, 70, ? | 50 | å·®ãŒ5ãšã¤å¢—åŠ  (5, 10, 15, 20) |
| 5 | 1, 4, 9, 16, 25, ? | 36 | å¹³æ–¹æ•° (n^2) |

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è¦ç´„

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|---------|------|----------|------|
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Next.js (App Router) | 15.x | ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯Webã‚¢ãƒ—ãƒª |
| è¨€èª | TypeScript | 5.x | å‹å®‰å…¨ãªé–‹ç™º |
| ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° | Tailwind CSS | 4.x | ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆCSS |
| UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | shadcn/ui | latest | ã‚¢ã‚¯ã‚»ã‚·ãƒ–ãƒ«UIåŸºç›¤ |
| ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ | motion/react | latest | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»UIãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ |
| çŠ¶æ…‹ç®¡ç† | Zustand | 5.x | è»½é‡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ç®¡ç† |
| ãƒ­ãƒ¼ã‚«ãƒ«DB | idb (IndexedDB wrapper) | latest | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– |
| ã‚°ãƒ©ãƒ• | Recharts | latest | ã‚¹ã‚³ã‚¢æ¨ç§»ãƒ»ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ |
| PWA | next-pwa | latest | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« |
| éŸ³å£° | Web Audio API | - | ãƒœã‚¤ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»åŠ¹æœéŸ³ |
| é€šçŸ¥ | Web Push API + FCM | - | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ |

---

*Phase 2: è¨­è¨ˆ - æ©Ÿèƒ½ä»•æ§˜æ›¸*
*CCAGI SDK v3.5.0*
